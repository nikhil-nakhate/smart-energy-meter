###############################################################################
#                                                                             #
#                                                       26/Jan/2012  01:17:01 #
# IAR C/C++ Compiler V5.40.2.20380/W32, Evaluation edition for MSP430         #
# Copyright 1996-2011 IAR Systems AB.                                         #
#                                                                             #
#    __rt_version  =  3                                                       #
#    __double_size =  32                                                      #
#    __reg_r4      =  free                                                    #
#    __reg_r5      =  free                                                    #
#    __pic         =  no                                                      #
#    __core        =  430X                                                    #
#    __data_model  =  small                                                   #
#    Source file   =  C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\zstack\Z #
#                     AP\SE-SampleApp\Source\SimpleMeter\simplemeter.c        #
#    Command line  =  -f "C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\zsta #
#                     ck\ZAP\SE-SampleApp\EXP5438\..\..\Source\zap.cfg"       #
#                     (-DZAP_PHY_SPI=1 -DZAP_PHY_UART=!ZAP_PHY_SPI            #
#                     -DZAP_PHY_RESET_ZNP=TRUE -DZAP_ZNP_MT=FALSE             #
#                     -DZAP_APP_MSG=FALSE -DZAP_SBL_PROXY=FALSE               #
#                     -DZAP_AUTO_CFG=TRUE -DZAP_AUTO_START=TRUE               #
#                     -DZAP_NV_RESTORE=FALSE -DLCD_SUPPORTED                  #
#                     -DZAP_AF_DATA_REQ_FRAG=FALSE                            #
#                     -DZAP_AF_DATA_REQ_AREQ=!ZAP_AF_DATA_REQ_FRAG            #
#                     -DZAP_ZDO_STARTUP_AREQ=TRUE -DZAP_AF_FUNC               #
#                     -DZAP_SAPI_FUNC -DZAP_SYS_FUNC -DZAP_UTIL_FUNC          #
#                     -DZAP_ZDO_FUNC -DSECURE=0 -DZG_SECURE_DYNAMIC=0         #
#                     "-DDEFAULT_CHANLIST=(uint32)0x00000800"                 #
#                     -DZDAPP_CONFIG_PAN_ID=0xFFFF -DPOLL_RATE=1000           #
#                     -DNWK_START_DELAY=100 -DMAX_BINDING_CLUSTER_IDS=4) -f   #
#                     "C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ #
#                     ZAP\SE-SampleApp\EXP5438\..\..\..\Tools\MSP5438\f8wZCL. #
#                     cfg" (-DZCL_READ -DZCL_WRITE -DZCL_BASIC                #
#                     -DZCL_IDENTIFY -DZCL_ON_OFF -DZCL_KEY_ESTABLISH         #
#                     -DZCL_KEY_ESTABLISHMENT_KEY_GENERATE_TIMEOUT=4          #
#                     -DZCL_KEY_ESTABLISHMENT_MAC_GENERATE_TIMEOUT=10         #
#                     -DZCL_KEY_ESTABLISHMENT_EKEY_GENERATE_TIMEOUT=10        #
#                     -DZCL_LOAD_CONTROL -DZCL_SIMPLE_METERING -DZCL_PRICING  #
#                     -DZCL_MESSAGE) "C:\Texas Instruments\ZAP-MSP430-2.5.0\P #
#                     rojects\zstack\ZAP\SE-SampleApp\Source\SimpleMeter\simp #
#                     lemeter.c" -D ZAP_DEVICETYPE=ZG_DEVICETYPE_ENDDEVICE    #
#                     -D TC_LINKKEY_JOIN -D ZCL_REPORT -lC "C:\Texas          #
#                     Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ZAP\SE-Sam #
#                     pleApp\EXP5438\Simple Metering - End Device\List\" -lA  #
#                     "C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ #
#                     ZAP\SE-SampleApp\EXP5438\Simple Metering - End          #
#                     Device\List\" --remarks --diag_suppress                 #
#                     Pe001,Pe193,Pe236,Pe826 -o "C:\Texas                    #
#                     Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ZAP\SE-Sam #
#                     pleApp\EXP5438\Simple Metering - End Device\Obj\"       #
#                     --debug -D__MSP430F5438__ -e --double=32 --clib -I      #
#                     "C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ #
#                     ZAP\SE-SampleApp\EXP5438\" -I "C:\Texas                 #
#                     Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ZAP\SE-Sam #
#                     pleApp\EXP5438\..\Source\" -I "C:\Texas                 #
#                     Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ZAP\SE-Sam #
#                     pleApp\EXP5438\..\..\Source\" -I "C:\Texas              #
#                     Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ZAP\SE-Sam #
#                     pleApp\EXP5438\..\..\..\..\..\Components\hal\target\MSP #
#                     5438ZAP\" -I "C:\Texas Instruments\ZAP-MSP430-2.5.0\Pro #
#                     jects\zstack\ZAP\SE-SampleApp\EXP5438\..\..\..\..\..\Co #
#                     mponents\hal\include\" -I "C:\Texas                     #
#                     Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ZAP\SE-Sam #
#                     pleApp\EXP5438\..\..\..\..\..\Components\mac\include\"  #
#                     -I "C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\zsta #
#                     ck\ZAP\SE-SampleApp\EXP5438\..\..\..\..\..\Components\m #
#                     t\" -I "C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\ #
#                     zstack\ZAP\SE-SampleApp\EXP5438\..\..\..\..\..\Componen #
#                     ts\osal\include\" -I "C:\Texas                          #
#                     Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ZAP\SE-Sam #
#                     pleApp\EXP5438\..\..\..\..\..\Components\osal\mcu\msp43 #
#                     0\" -I "C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\ #
#                     zstack\ZAP\SE-SampleApp\EXP5438\..\..\..\..\..\Componen #
#                     ts\services\saddr\" -I "C:\Texas                        #
#                     Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ZAP\SE-Sam #
#                     pleApp\EXP5438\..\..\..\..\..\Components\services\sdata #
#                     \" -I "C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\z #
#                     stack\ZAP\SE-SampleApp\EXP5438\..\..\..\..\..\Component #
#                     s\stack\af\" -I "C:\Texas Instruments\ZAP-MSP430-2.5.0\ #
#                     Projects\zstack\ZAP\SE-SampleApp\EXP5438\..\..\..\..\.. #
#                     \Components\stack\nwk\" -I "C:\Texas                    #
#                     Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ZAP\SE-Sam #
#                     pleApp\EXP5438\..\..\..\..\..\Components\stack\sapi\"   #
#                     -I "C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\zsta #
#                     ck\ZAP\SE-SampleApp\EXP5438\..\..\..\..\..\Components\s #
#                     tack\sec\" -I "C:\Texas Instruments\ZAP-MSP430-2.5.0\Pr #
#                     ojects\zstack\ZAP\SE-SampleApp\EXP5438\..\..\..\..\..\C #
#                     omponents\stack\sys\" -I "C:\Texas                      #
#                     Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ZAP\SE-Sam #
#                     pleApp\EXP5438\..\..\..\..\..\Components\stack\zcl\"    #
#                     -I "C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\zsta #
#                     ck\ZAP\SE-SampleApp\EXP5438\..\..\..\..\..\Components\s #
#                     tack\zdo\" -I "C:\Texas Instruments\ZAP-MSP430-2.5.0\Pr #
#                     ojects\zstack\ZAP\SE-SampleApp\EXP5438\..\..\..\..\..\C #
#                     omponents\zmac\" -I "C:\Texas                           #
#                     Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ZAP\SE-Sam #
#                     pleApp\EXP5438\..\..\..\..\..\Components\zmac\f8w\"     #
#                     --core=430X --data_model=small -Ohz --multiplier=32     #
#                     --multiplier_location=4C0 --require_prototypes          #
#                     --hw_workaround=CPU40                                   #
#    List file     =  C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\zstack\Z #
#                     AP\SE-SampleApp\EXP5438\Simple Metering - End           #
#                     Device\List\simplemeter.lst                             #
#    Object file   =  C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\zstack\Z #
#                     AP\SE-SampleApp\EXP5438\Simple Metering - End           #
#                     Device\Obj\simplemeter.r43                              #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZAP-MSP430-2.5.0\Projects\zstack\ZAP\SE-SampleApp\Source\SimpleMeter\simplemeter.c
      1          /**************************************************************************************************
      2            Filename:       simplemeter.c
      3            Revised:        $Date: 2011-05-20 16:26:11 -0700 (Fri, 20 May 2011) $
      4            Revision:       $Revision: 26054 $
      5          
      6            Description:    This module implements the Simple Meter functionality and
      7                            contains the init and event loop functions
      8          
      9          
     10            Copyright 2009-2011 Texas Instruments Incorporated. All rights reserved.
     11          
     12            IMPORTANT: Your use of this Software is limited to those specific rights
     13            granted under the terms of a software license agreement between the user
     14            who downloaded the software, his/her employer (which must be your employer)
     15            and Texas Instruments Incorporated (the "License").  You may not use this
     16            Software unless you agree to abide by the terms of the License. The License
     17            limits your use, and you acknowledge, that the Software may not be modified,
     18            copied or distributed unless embedded on a Texas Instruments microcontroller
     19            or used solely and exclusively in conjunction with a Texas Instruments radio
     20            frequency transceiver, which is integrated into your product.  Other than for
     21            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     22            works of, modify, distribute, perform, display or sell this Software and/or
     23            its documentation for any purpose.
     24          
     25            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     26            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     27            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     28            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     29            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     30            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     31            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     32            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     33            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     34            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     35            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     36          
     37            Should you have any questions regarding your right to use this Software,
     38            contact Texas Instruments Incorporated at www.TI.com.
     39          **************************************************************************************************/
     40          
     41          /*********************************************************************
     42            This application is designed for the test purpose of the SE profile which
     43            exploits the following clusters for a Simple Metering configuration:
     44          
     45            General Basic
     46            General Alarms
     47            General Time
     48            General Key Establishment
     49            SE     Simple Metering
     50          
     51            Key control:
     52              SW1:  Join Network
     53              SW2:  N/A
     54              SW3:  N/A
     55              SW4:  N/A
     56          
     57          *********************************************************************/
     58          
     59          /*********************************************************************
     60           * INCLUDES
     61           */
     62          
     63          #include "OSAL.h"
     64          #include "OSAL_Clock.h"
     65          #include "OSAL_Nv.h"
     66          #include "ZDApp.h"
     67          #include "ZDObject.h"
     68          #include "AddrMgr.h"
     69          
     70          #include "se.h"
     71          #include "simplemeter.h"
     72          #include "zcl_general.h"
     73          #include "zcl_se.h"
     74          #include "zcl_key_establish.h"
     75          
     76          #include "onboard.h"
     77          
     78          /* HAL */
     79          #include "hal_lcd.h"
     80          #include "hal_led.h"
     81          #include "hal_key.h"
     82          
     83          
     84          /*********************************************************************
     85           * MACROS
     86           */
     87          
     88          // There is no attribute in the Mandatory Reportable Attribute list for now
     89          #define zcl_MandatoryReportableAttribute( a ) ( a == NULL )
     90          
     91          /*********************************************************************
     92           * CONSTANTS
     93           */
     94          
     95          #define SIMPLEMETER_MIN_REPORTING_INTERVAL       5
     96          
     97          /*********************************************************************
     98           * TYPEDEFS
     99           */
    100          
    101          /*********************************************************************
    102           * GLOBAL VARIABLES
    103           */
    104          
    105          /*********************************************************************
    106           * GLOBAL FUNCTIONS
    107           */
    108          
    109          /*********************************************************************
    110           * LOCAL VARIABLES
    111           */
    112          

   \                                 In  segment DATA16_Z, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    113          static uint8 simpleMeterTaskID;                                    // osal task id of simple meter
   \                     simpleMeterTaskID:
   \   000000                DS8 1

   \                                 In  segment DATA16_Z, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    114          static uint8 simpleMeterTransID;                                   // transaction id
   \                     simpleMeterTransID:
   \   000000                DS8 1

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    115          static afAddrType_t ESPAddr;                                       // esp destination address
   \                     ESPAddr:
   \   000000                DS8 12

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    116          static zclReportCmd_t *pReportCmd;                                 // report command structure
   \                     pReportCmd:
   \   000000                DS8 2

   \                                 In  segment DATA16_I, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_copy
    117          static uint8 numAttr = 1;                                          // number of attributes in report
   \                     numAttr:
   \   000000                DS8 1
   \   000001                REQUIRE `?<Initializer for numAttr>`
    118          extern uint8 simpleMeterCurrentSummationDelivered[];               // defined in simplemeter_data.c
    119          #if SECURE
    120          static uint8 linkKeyStatus;                                        // status return from get link key routine
    121          #endif
    122          
    123          /*********************************************************************
    124           * LOCAL FUNCTIONS
    125           */
    126          static void simplemeter_HandleKeys( uint8 shift, uint8 keys );
    127          
    128          #if SECURE
    129          static uint8 simplemeter_KeyEstablish_ReturnLinkKey( uint16 shortAddr );
    130          #endif
    131          
    132          #if defined ( ZCL_ALARMS )
    133          static void simplemeter_ProcessAlarmCmd( uint8 srcEP, afAddrType_t *dstAddr,
    134                                  uint16 clusterID, zclFrameHdr_t *hdr, uint8 len, uint8 *data );
    135          #endif // ZCL_ALARMS
    136          
    137          static void simplemeter_ProcessIdentifyTimeChange( void );
    138          
    139          /*************************************************************************/
    140          /*** Application Callback Functions                                    ***/
    141          /*************************************************************************/
    142          
    143          // Foundation Callback functions
    144          static uint8 simplemeter_ValidateAttrDataCB( zclAttrRec_t *pAttr, zclWriteRec_t *pAttrInfo );
    145          
    146          // General Cluster Callback functions
    147          static void simplemeter_BasicResetCB( void );
    148          static void simplemeter_IdentifyCB( zclIdentify_t *pCmd );
    149          static void simplemeter_IdentifyQueryRspCB( zclIdentifyQueryRsp_t *pRsp );
    150          static void simplemeter_AlarmCB( zclAlarm_t *pAlarm );
    151          
    152          // Function to process ZDO callback messages
    153          static void simplemeter_ProcessZDOMsgs( zdoIncomingMsg_t *pMsg );
    154          
    155          // SE Callback functions
    156          static void simplemeter_GetProfileCmdCB( zclCCGetProfileCmd_t *pCmd,
    157                                                 afAddrType_t *srcAddr, uint8 seqNum );
    158          static void simplemeter_GetProfileRspCB( zclCCGetProfileRsp_t *pCmd,
    159                                                 afAddrType_t *srcAddr, uint8 seqNum );
    160          static void simplemeter_ReqMirrorCmdCB( afAddrType_t *srcAddr, uint8 seqNum );
    161          static void simplemeter_ReqMirrorRspCB( zclCCReqMirrorRsp_t *pCmd,
    162                                                 afAddrType_t *srcAddr, uint8 seqNum );
    163          static void simplemeter_MirrorRemCmdCB( afAddrType_t *srcAddr, uint8 seqNum );
    164          static void simplemeter_MirrorRemRspCB( zclCCMirrorRemRsp_t *pCmd,
    165                                                 afAddrType_t *srcAddr, uint8 seqNum );
    166          
    167          
    168          /************************************************************************/
    169          /***               Functions to process ZCL Foundation                ***/
    170          /***               incoming Command/Response messages                 ***/
    171          /************************************************************************/
    172          static void simplemeter_ProcessZCLMsg( zclIncomingMsg_t *msg );
    173          #if defined ( ZCL_READ )
    174          static uint8 simplemeter_ProcessInReadRspCmd( zclIncomingMsg_t *pInMsg );
    175          #endif // ZCL_READ
    176          #if defined ( ZCL_WRITE )
    177          static uint8 simplemeter_ProcessInWriteRspCmd( zclIncomingMsg_t *pInMsg );
    178          #endif // ZCL_WRITE
    179          #if defined ( ZCL_REPORT )
    180          static uint8 simplemeter_ProcessInConfigReportCmd( zclIncomingMsg_t *pInMsg );
    181          static uint8 simplemeter_ProcessInConfigReportRspCmd( zclIncomingMsg_t *pInMsg );
    182          static uint8 simplemeter_ProcessInReadReportCfgCmd( zclIncomingMsg_t *pInMsg );
    183          static uint8 simplemeter_ProcessInReadReportCfgRspCmd( zclIncomingMsg_t *pInMsg );
    184          static uint8 simplemeter_ProcessInReportCmd( zclIncomingMsg_t *pInMsg );
    185          #endif // ZCL_REPORT
    186          static uint8 simplemeter_ProcessInDefaultRspCmd( zclIncomingMsg_t *pInMsg );
    187          #if defined ( ZCL_DISCOVER )
    188          static uint8 simplemeter_ProcessInDiscRspCmd( zclIncomingMsg_t *pInMsg );
    189          #endif // ZCL_DISCOVER
    190          
    191          /*********************************************************************
    192           * ZCL General Clusters Callback table
    193           */

   \                                 In  segment DATA16_I, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_copy
    194          static zclGeneral_AppCallbacks_t simplemeter_GenCmdCallbacks =
   \                     simplemeter_GenCmdCallbacks:
   \   000000                DS8 60
   \   00003C                REQUIRE `?<Initializer for simplemeter_GenCmdCallbacks>`
    195          {
    196            simplemeter_BasicResetCB,              // Basic Cluster Reset command
    197            simplemeter_IdentifyCB,                // Identify command
    198            simplemeter_IdentifyQueryRspCB,        // Identify Query Response command
    199            NULL,                                  // On/Off cluster commands
    200            NULL,                                  // Level Control Move to Level command
    201            NULL,                                  // Level Control Move command
    202            NULL,                                  // Level Control Step command
    203            NULL,                                  // Level Control Stop command
    204            NULL,                                  // Group Response commands
    205            NULL,                                  // Scene Store Request command
    206            NULL,                                  // Scene Recall Request command
    207            NULL,                                  // Scene Response command
    208            simplemeter_AlarmCB,                   // Alarm (Response) command
    209            NULL,                                  // RSSI Location command
    210            NULL                                   // RSSI Location Response command
    211          };
    212          
    213          /*********************************************************************
    214           * ZCL SE Clusters Callback table
    215           */

   \                                 In  segment DATA16_I, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_copy
    216          static zclSE_AppCallbacks_t simplemeter_SECmdCallbacks =			
   \                     simplemeter_SECmdCallbacks:
   \   000000                DS8 104
   \   000068                REQUIRE `?<Initializer for simplemeter_SECmdCallbacks>`
    217          {
    218            simplemeter_GetProfileCmdCB,                        // Get Profile Command
    219            simplemeter_GetProfileRspCB,                        // Get Profile Response
    220            simplemeter_ReqMirrorCmdCB,                         // Request Mirror Command
    221            simplemeter_ReqMirrorRspCB,                         // Request Mirror Response
    222            simplemeter_MirrorRemCmdCB,                         // Mirror Remove Command
    223            simplemeter_MirrorRemRspCB,                         // Mirror Remove Response
    224            NULL,                                               // Get Current Price
    225            NULL,                                               // Get Scheduled Price
    226            NULL,                                               // Publish Price
    227            NULL,                                               // Display Message Command
    228            NULL,                                               // Cancel Message Command
    229            NULL,                                               // Get Last Message Command
    230            NULL,                                               // Message Confirmation
    231            NULL,                                               // Load Control Event
    232            NULL,                                               // Cancel Load Control Event
    233            NULL,                                               // Cancel All Load Control Events
    234            NULL,                                               // Report Event Status
    235            NULL,                                               // Get Scheduled Event
    236            NULL,                                               // Request Fast Poll Mode Command
    237            NULL,                                               // Request Fast Poll Mode Response
    238            NULL,                                               // Price Acknowledgement
    239            NULL,                                               // Get Block Period
    240            NULL,                                               // Publish Block Period
    241            NULL,                                               // Select Available Emergency Credit Command
    242            NULL,                                               // Change Supply Command
    243            NULL                                                // Supply Status Response
    244          };
    245          
    246          /*********************************************************************
    247           * @fn          simplemeter_Init
    248           *
    249           * @brief       Initialization function for the ZCL App Application.
    250           *
    251           * @param       uint8 task_id - simple meter task id
    252           *
    253           * @return      none
    254           */

   \                                 In  segment CODE, align 2
    255          void simplemeter_Init( uint8 task_id )
   \                     simplemeter_Init:
    256          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   4A4C         MOV.B   R12, R10
    257            simpleMeterTaskID = task_id;
   \   000004   C24C....     MOV.B   R12, &simpleMeterTaskID
    258            simpleMeterTransID = 0;
   \   000008   C243....     MOV.B   #0x0, &simpleMeterTransID
    259          
    260            // Device hardware initialization can be added here or in main() (Zmain.c).
    261            // If the hardware is application specific - add it here.
    262            // If the hardware is other parts of the device add it in main().
    263          
    264            // ESP destination address init
    265            ESPAddr.addrMode = (afAddrMode_t)Addr16Bit;
   \   00000C   E243....     MOV.B   #0x2, &ESPAddr + 8
    266            ESPAddr.endPoint = SIMPLEMETER_ENDPOINT;
   \   000010   7B400900     MOV.B   #0x9, R11
   \   000014   C24B....     MOV.B   R11, &ESPAddr + 9
    267            ESPAddr.addr.shortAddr = 0;
   \   000018   8243....     MOV.W   #0x0, &ESPAddr
    268          
    269            // register for SE endpoint
    270            zclSE_Init( &simpleMeterSimpleDesc );
   \   00001C   3C40....     MOV.W   #simpleMeterSimpleDesc, R12
   \   000020   ........     CALLA   #zclSE_Init
    271          
    272            // Register the ZCL General Cluster Library callback functions
    273            zclGeneral_RegisterCmdCallbacks( SIMPLEMETER_ENDPOINT, &simplemeter_GenCmdCallbacks );
   \   000024   3D40....     MOV.W   #simplemeter_GenCmdCallbacks, R13
   \   000028   4C4B         MOV.B   R11, R12
   \   00002A   ........     CALLA   #zclGeneral_RegisterCmdCallbacks
    274          
    275            // Register the ZCL SE Cluster Library callback functions
    276            zclSE_RegisterCmdCallbacks( SIMPLEMETER_ENDPOINT, &simplemeter_SECmdCallbacks );
   \   00002E   3D40....     MOV.W   #simplemeter_SECmdCallbacks, R13
   \   000032   4C4B         MOV.B   R11, R12
   \   000034   ........     CALLA   #zclSE_RegisterCmdCallbacks
    277          
    278            // Register the application's attribute list
    279            zcl_registerAttrList( SIMPLEMETER_ENDPOINT, SIMPLEMETER_MAX_ATTRIBUTES, simpleMeterAttrs );
   \   000038   3E40....     MOV.W   #simpleMeterAttrs, R14
   \   00003C   7D403600     MOV.B   #0x36, R13
   \   000040   4C4B         MOV.B   R11, R12
   \   000042   ........     CALLA   #zcl_registerAttrList
    280          
    281            // Register the application's cluster option list
    282            zcl_registerClusterOptionList( SIMPLEMETER_ENDPOINT, SIMPLEMETER_MAX_OPTIONS, simpleMeterOptions );
   \   000046   3E40....     MOV.W   #simpleMeterOptions, R14
   \   00004A   6D43         MOV.B   #0x2, R13
   \   00004C   4C4B         MOV.B   R11, R12
   \   00004E   ........     CALLA   #zcl_registerClusterOptionList
    283          
    284            // Register the application's attribute data validation callback function
    285            zcl_registerValidateAttrData( simplemeter_ValidateAttrDataCB );
   \   000052   3C40....     MOV.W   #LWRD(simplemeter_ValidateAttrDataCB), R12
   \   000056   3D40....     MOV.W   #HWRD(simplemeter_ValidateAttrDataCB), R13
   \   00005A   ........     CALLA   #zcl_registerValidateAttrData
    286          
    287            // Register the Application to receive the unprocessed Foundation command/response messages
    288            zcl_registerForMsg( simpleMeterTaskID );
   \   00005E   5C42....     MOV.B   &simpleMeterTaskID, R12
   \   000062   ........     CALLA   #zcl_registerForMsg
    289          
    290            // Register for all key events - This app will handle all key events
    291            RegisterForKeys( simpleMeterTaskID );
   \   000066   5C42....     MOV.B   &simpleMeterTaskID, R12
   \   00006A   ........     CALLA   #RegisterForKeys
    292          
    293            // Register with the ZDO to receive Match Descriptor Responses
    294            ZDO_RegisterForZDOMsg(task_id, Match_Desc_rsp);
   \   00006E   3D400680     MOV.W   #0x8006, R13
   \   000072   4C4A         MOV.B   R10, R12
   \   000074   ........     CALLA   #ZDO_RegisterForZDOMsg
    295          
    296            // Start the timer to sync SimpleMeter timer with the osal timer
    297            osal_start_timerEx( simpleMeterTaskID, SIMPLEMETER_UPDATE_TIME_EVT, SIMPLEMETER_UPDATE_TIME_PERIOD );
   \   000078   3E40E803     MOV.W   #0x3e8, R14
   \   00007C   2D43         MOV.W   #0x2, R13
   \   00007E   5C42....     MOV.B   &simpleMeterTaskID, R12
   \   000082   ........     CALLA   #osal_start_timerEx
    298          
    299            // setup attribute IDs of interest for Simple Meter
    300          
    301            pReportCmd = (zclReportCmd_t *)osal_mem_alloc( sizeof( zclReportCmd_t ) + ( numAttr * sizeof( zclReport_t ) ) );
   \   000086   5F42....     MOV.B   &numAttr, R15
   \   00008A   2C43         MOV.W   #0x2, R12
   \   00008C                RPT     #0x6
   \   00008C   45180C5F     ADDX.W  R15, R12
   \   000090   ........     CALLA   #osal_mem_alloc
   \   000094   824C....     MOV.W   R12, &pReportCmd
    302            if ( pReportCmd != NULL )
   \   000098   0C93         CMP.W   #0x0, R12
   \   00009A   0B24         JEQ     ??simplemeter_Init_0
    303            {
    304              pReportCmd->numAttr = numAttr;
   \   00009C   DC42....0000 MOV.B   &numAttr, 0(R12)
    305          
    306              // Set up the first attribute
    307              pReportCmd->attrList[0].attrID = ATTRID_SE_CURRENT_SUMMATION_DELIVERED;
   \   0000A2   8C430200     MOV.W   #0x0, 0x2(R12)
    308              pReportCmd->attrList[0].dataType = ZCL_DATATYPE_UINT48;
   \   0000A6   FC4025000400 MOV.B   #0x25, 0x4(R12)
    309              pReportCmd->attrList[0].attrData = simpleMeterCurrentSummationDelivered;
   \   0000AC   BC40....0600 MOV.W   #simpleMeterCurrentSummationDelivered, 0x6(R12)
    310          
    311              // Set up the remaining attributes
    312            }
    313          }
   \                     ??simplemeter_Init_0:
   \   0000B2   1A17         POPM.W  #0x2, R11
   \   0000B4   1001         RETA
    314          
    315          /*********************************************************************
    316           * @fn          simplemeter_event_loop
    317           *
    318           * @brief       Event Loop Processor for the simple meter.
    319           *
    320           * @param       uint8 task_id - the osal task id
    321           * @param       uint16 events - the event bitmask
    322           *
    323           * @return      none
    324           */

   \                                 In  segment CODE, align 2
    325          uint16 simplemeter_event_loop( uint8 task_id, uint16 events )
   \                     simplemeter_event_loop:
    326          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   0A4D         MOV.W   R13, R10
   \   000004   3B40....     MOV.W   #simpleMeterTaskID, R11
   \   000008   0D93         CMP.W   #0x0, R13
   \   00000A   1638         JL      ??simplemeter_event_loop_4
    327            afIncomingMSGPacket_t *MSGpkt;
    328          
    329            if ( events & SYS_EVENT_MSG )
    330            {
    331              while ( (MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( simpleMeterTaskID )) )
    332              {
    333                switch ( MSGpkt->hdr.event )
    334                {
    335                  case ZDO_CB_MSG:
    336                    simplemeter_ProcessZDOMsgs( (zdoIncomingMsg_t *)MSGpkt );
    337                    break;
    338          
    339                  case ZCL_INCOMING_MSG:
    340                    // Incoming ZCL foundation command/response messages
    341                    simplemeter_ProcessZCLMsg( (zclIncomingMsg_t *)MSGpkt );
    342                    break;
    343          
    344                  case KEY_CHANGE:
    345                    simplemeter_HandleKeys( ((keyChange_t *)MSGpkt)->state, ((keyChange_t *)MSGpkt)->keys );
    346                    break;
    347          
    348                  case ZDO_STATE_CHANGE:
    349                    if ((DEV_END_DEVICE == (devStates_t)(MSGpkt->hdr.status)) ||
    350                        (DEV_ROUTER == (devStates_t)(MSGpkt->hdr.status)))
    351                    {
    352          #if SECURE
    353                      {
    354                        // check to see if link key had already been established
    355                        linkKeyStatus = simplemeter_KeyEstablish_ReturnLinkKey(ESPAddr.addr.shortAddr);
    356          
    357                        if (linkKeyStatus != ZSuccess)
    358                        {
    359                          cId_t cbkeCluster = ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT;
    360                          zAddrType_t dstAddr;
    361          
    362                          // Send out a match for the key establishment
    363                          dstAddr.addrMode = AddrBroadcast;
    364                          dstAddr.addr.shortAddr = NWK_BROADCAST_SHORTADDR;
    365                          ZDP_MatchDescReq( &dstAddr, NWK_BROADCAST_SHORTADDR, ZCL_SE_PROFILE_ID,
    366                                            1, &cbkeCluster, 0, NULL, FALSE );
    367                        }
    368                        else
    369                        {
    370                          // link key already established, resume sending reports
    371                          osal_start_timerEx( simpleMeterTaskID, SIMPLEMETER_REPORT_ATTRIBUTE_EVT,
    372                                                                 SIMPLEMETER_REPORT_PERIOD );
    373                        }
    374                      }
    375          #else
    376                      {
    377                        osal_start_timerEx( simpleMeterTaskID, SIMPLEMETER_REPORT_ATTRIBUTE_EVT,
    378                                                               SIMPLEMETER_REPORT_PERIOD );
    379                      }
    380          #endif
    381                      // per smart energy spec end device polling requirement of not to poll < 7.5 seconds
    382                      NLME_SetPollRate ( SE_DEVICE_POLL_RATE );
    383                    }
    384                    break;
    385          
    386          #if defined( ZCL_KEY_ESTABLISH )
    387                  case ZCL_KEY_ESTABLISH_IND:
    388                    if ((MSGpkt->hdr.status) == TermKeyStatus_Success)
    389                    {
    390                      ESPAddr.endPoint = SIMPLEMETER_ENDPOINT; // set destination endpoint back to application endpoint
    391                      osal_start_timerEx( simpleMeterTaskID, SIMPLEMETER_REPORT_ATTRIBUTE_EVT, SIMPLEMETER_REPORT_PERIOD );
    392                    }
    393          
    394                    break;
    395          #endif
    396          
    397                  default:
    398                    break;
    399                }
    400          
    401                // Release the memory
    402                osal_msg_deallocate( (uint8 *)MSGpkt );
    403          
    404              }
    405          
    406              // return unprocessed events
    407              return (events ^ SYS_EVENT_MSG);
    408            }
    409          
    410            // event to intiate key establishment request
    411            if ( events & SIMPLEMETER_KEY_ESTABLISHMENT_REQUEST_EVT )
   \   00000C   2DB2         BIT.W   #0x4, R13
   \   00000E   4A28         JNC     ??simplemeter_event_loop_5
    412            {
    413              zclGeneral_KeyEstablish_InitiateKeyEstablishment(simpleMeterTaskID, &ESPAddr, simpleMeterTransID);
   \   000010   5E42....     MOV.B   &simpleMeterTransID, R14
   \   000014   3D40....     MOV.W   #ESPAddr, R13
   \   000018   6C4B         MOV.B   @R11, R12
   \   00001A   ........     CALLA   #zclGeneral_KeyEstablish_InitiateKeyEstablishment
    414          
    415              return ( events ^ SIMPLEMETER_KEY_ESTABLISHMENT_REQUEST_EVT );
   \   00001E   2AE2         XOR.W   #0x4, R10
   \   000020   733C         JMP     ??simplemeter_event_loop_3
    416            }
   \                     ??simplemeter_event_loop_0:
   \   000022   CC930100     CMP.B   #0x0, 0x1(R12)
   \   000026   0520         JNE     ??simplemeter_event_loop_1
   \   000028   F2400900.... MOV.B   #0x9, &ESPAddr + 9
   \   00002E   ........     CALLA   #?Subroutine2
   \                     ??simplemeter_event_loop_1:
   \   000032   0C48         MOV.W   R8, R12
   \   000034   ........     CALLA   #osal_msg_deallocate
   \                     ??simplemeter_event_loop_4:
   \   000038   6C4B         MOV.B   @R11, R12
   \   00003A   ........     CALLA   #osal_msg_receive
   \   00003E   084C         MOV.W   R12, R8
   \   000040   0C93         CMP.W   #0x0, R12
   \   000042   2D24         JEQ     ??simplemeter_event_loop_6
   \   000044   6E4C         MOV.B   @R12, R14
   \   000046   7E803400     SUB.B   #0x34, R14
   \   00004A   0D24         JEQ     ??simplemeter_event_loop_7
   \   00004C   5E83         SUB.B   #0x1, R14
   \   00004E   E927         JEQ     ??simplemeter_event_loop_0
   \   000050   7E808B00     SUB.B   #0x8b, R14
   \   000054   0B24         JEQ     ??simplemeter_event_loop_8
   \   000056   7E801100     SUB.B   #0x11, R14
   \   00005A   1224         JEQ     ??simplemeter_event_loop_9
   \   00005C   6E83         SUB.B   #0x2, R14
   \   00005E   E923         JNE     ??simplemeter_event_loop_1
   \   000060   ........     CALLA   #simplemeter_ProcessZDOMsgs
   \   000064   E63F         JMP     ??simplemeter_event_loop_1
   \                     ??simplemeter_event_loop_7:
   \   000066   ........     CALLA   #simplemeter_ProcessZCLMsg
   \   00006A   E33F         JMP     ??simplemeter_event_loop_1
   \                     ??simplemeter_event_loop_8:
   \   00006C   CC930200     CMP.B   #0x0, 0x2(R12)
   \   000070   E023         JNE     ??simplemeter_event_loop_1
   \   000072   DCB30300     BIT.B   #0x1, 0x3(R12)
   \   000076   DD2B         JNC     ??simplemeter_event_loop_1
   \   000078   0C43         MOV.W   #0x0, R12
   \   00007A   ........     CALLA   #ZDOInitDevice
   \   00007E   D93F         JMP     ??simplemeter_event_loop_1
   \                     ??simplemeter_event_loop_9:
   \   000080   5E4C0100     MOV.B   0x1(R12), R14
   \   000084   7E900600     CMP.B   #0x6, R14
   \   000088   0324         JEQ     ??simplemeter_event_loop_10
   \   00008A   7E900700     CMP.B   #0x7, R14
   \   00008E   D123         JNE     ??simplemeter_event_loop_1
   \                     ??simplemeter_event_loop_10:
   \   000090   ........     CALLA   #?Subroutine2
   \                     ??CrossCallReturnLabel_1:
   \   000094   3C40401F     MOV.W   #0x1f40, R12
   \   000098   ........     CALLA   #NLME_SetPollRate
   \   00009C   CA3F         JMP     ??simplemeter_event_loop_1
   \                     ??simplemeter_event_loop_6:
   \   00009E   3AE00080     XOR.W   #0x8000, R10
   \   0000A2   323C         JMP     ??simplemeter_event_loop_3
    417          
    418            // event to send report attribute
    419            if ( events & SIMPLEMETER_REPORT_ATTRIBUTE_EVT )
   \                     ??simplemeter_event_loop_5:
   \   0000A4   3DB2         BIT.W   #0x8, R13
   \   0000A6   1628         JNC     ??simplemeter_event_loop_11
    420            {
    421              if ( pReportCmd != NULL )
   \   0000A8   8293....     CMP.W   #0x0, &pReportCmd
   \   0000AC   1124         JEQ     ??simplemeter_event_loop_12
    422              {
    423                zcl_SendReportCmd( SIMPLEMETER_ENDPOINT, &ESPAddr,
    424                                   ZCL_CLUSTER_ID_SE_SIMPLE_METERING, pReportCmd,
    425                                   ZCL_FRAME_SERVER_CLIENT_DIR, 1, 0 );
   \   0000AE   4312         PUSH.B  #0x0
   \   0000B0   5312         PUSH.B  #0x1
   \   0000B2   5312         PUSH.B  #0x1
   \   0000B4   1F42....     MOV.W   &pReportCmd, R15
   \   0000B8   3E400207     MOV.W   #0x702, R14
   \   0000BC   3D40....     MOV.W   #ESPAddr, R13
   \   0000C0   7C400900     MOV.B   #0x9, R12
   \   0000C4   ........     CALLA   #zcl_SendReportCmd
    426          
    427                osal_start_timerEx( simpleMeterTaskID, SIMPLEMETER_REPORT_ATTRIBUTE_EVT, SIMPLEMETER_REPORT_PERIOD );
   \   0000C8   ........     CALLA   #?Subroutine2
    428              }
   \                     ??CrossCallReturnLabel_0:
   \   0000CC   31500600     ADD.W   #0x6, SP
    429          
    430              return ( events ^ SIMPLEMETER_REPORT_ATTRIBUTE_EVT );
   \                     ??simplemeter_event_loop_12:
   \   0000D0   3AE2         XOR.W   #0x8, R10
   \   0000D2   1A3C         JMP     ??simplemeter_event_loop_3
    431            }
    432          
    433            // handle processing of identify timeout event triggered by an identify command
    434            if ( events & SIMPLEMETER_IDENTIFY_TIMEOUT_EVT )
   \                     ??simplemeter_event_loop_11:
   \   0000D4   1DB3         BIT.W   #0x1, R13
   \   0000D6   0928         JNC     ??simplemeter_event_loop_13
    435            {
    436              if ( simpleMeterIdentifyTime > 0 )
   \   0000D8   8293....     CMP.W   #0x0, &simpleMeterIdentifyTime
   \   0000DC   0224         JEQ     ??simplemeter_event_loop_14
    437              {
    438                simpleMeterIdentifyTime--;
   \   0000DE   B253....     ADD.W   #0xffff, &simpleMeterIdentifyTime
    439              }
    440              simplemeter_ProcessIdentifyTimeChange();
   \                     ??simplemeter_event_loop_14:
   \   0000E2   ........     CALLA   #simplemeter_ProcessIdentifyTimeChange
    441          
    442              return ( events ^ SIMPLEMETER_IDENTIFY_TIMEOUT_EVT );
   \   0000E6   1AE3         XOR.W   #0x1, R10
   \   0000E8   0F3C         JMP     ??simplemeter_event_loop_3
    443            }
    444          
    445            // event to get current time
    446            if ( events & SIMPLEMETER_UPDATE_TIME_EVT )
   \                     ??simplemeter_event_loop_13:
   \   0000EA   2DB3         BIT.W   #0x2, R13
   \   0000EC   0F28         JNC     ??simplemeter_event_loop_15
    447            {
    448              simpleMeterTime = osal_getClock();
   \   0000EE   ........     CALLA   #osal_getClock
   \   0000F2   824C....     MOV.W   R12, &simpleMeterTime
   \   0000F6   824D....     MOV.W   R13, &simpleMeterTime + 2
    449              osal_start_timerEx( simpleMeterTaskID, SIMPLEMETER_UPDATE_TIME_EVT, SIMPLEMETER_UPDATE_TIME_PERIOD );
   \   0000FA   3E40E803     MOV.W   #0x3e8, R14
   \   0000FE   2D43         MOV.W   #0x2, R13
   \   000100   6C4B         MOV.B   @R11, R12
   \   000102   ........     CALLA   #osal_start_timerEx
    450          
    451              return ( events ^ SIMPLEMETER_UPDATE_TIME_EVT );
   \   000106   2AE3         XOR.W   #0x2, R10
   \                     ??simplemeter_event_loop_3:
   \   000108   0C4A         MOV.W   R10, R12
   \   00010A   013C         JMP     ??simplemeter_event_loop_16
    452            }
    453          
    454            // Discard unknown events
    455            return 0;
   \                     ??simplemeter_event_loop_15:
   \   00010C   0C43         MOV.W   #0x0, R12
   \                     ??simplemeter_event_loop_16:
   \   00010E   3817         POPM.W  #0x4, R11
   \   000110   1001         RETA
    456          }

   \                                 In  segment CODE, align 2
   \                     ?Subroutine2:
   \   000000   3E408813     MOV.W   #0x1388, R14
   \   000004   3D42         MOV.W   #0x8, R13
   \   000006   6C4B         MOV.B   @R11, R12
   \   000008   ........     BRA     #osal_start_timerEx
    457          
    458          /*********************************************************************
    459           * @fn      simplemeter_ProcessZDOMsgs
    460           *
    461           * @brief   Called to process callbacks from the ZDO.
    462           *
    463           * @param   none
    464           *
    465           * @return  none
    466           */

   \                                 In  segment CODE, align 2
    467          static void simplemeter_ProcessZDOMsgs( zdoIncomingMsg_t *pMsg )
   \                     simplemeter_ProcessZDOMsgs:
    468          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   0A4C         MOV.W   R12, R10
    469            if (pMsg->clusterID == Match_Desc_rsp)
   \   000004   BC9006800E00 CMP.W   #0x8006, 0xe(R12)
   \   00000A   1620         JNE     ??simplemeter_ProcessZDOMsgs_0
    470            {
    471              ZDO_ActiveEndpointRsp_t *pRsp = ZDO_ParseEPListRsp( pMsg );
   \   00000C   ........     CALLA   #ZDO_ParseEPListRsp
   \   000010   0B4C         MOV.W   R12, R11
    472          
    473              if (pRsp)
   \   000012   0C93         CMP.W   #0x0, R12
   \   000014   1124         JEQ     ??simplemeter_ProcessZDOMsgs_0
    474              {
    475                if (pRsp->cnt)
   \   000016   CC930400     CMP.B   #0x0, 0x4(R12)
   \   00001A   0B24         JEQ     ??simplemeter_ProcessZDOMsgs_1
    476                {
    477                  // Record the trust center
    478                  ESPAddr.endPoint = pRsp->epList[0];
   \   00001C   D24C0500.... MOV.B   0x5(R12), &ESPAddr + 9
    479                  ESPAddr.addr.shortAddr = pMsg->srcAddr.addr.shortAddr;
   \   000022   924A0200.... MOV.W   0x2(R10), &ESPAddr
    480          
    481                  // send out key establishment request
    482                  osal_set_event( simpleMeterTaskID, SIMPLEMETER_KEY_ESTABLISHMENT_REQUEST_EVT);
   \   000028   2D42         MOV.W   #0x4, R13
   \   00002A   5C42....     MOV.B   &simpleMeterTaskID, R12
   \   00002E   ........     CALLA   #osal_set_event
    483                }
    484                osal_mem_free(pRsp);
   \                     ??simplemeter_ProcessZDOMsgs_1:
   \   000032   0C4B         MOV.W   R11, R12
   \   000034   ........     CALLA   #osal_mem_free
    485              }
    486            }
    487          }
   \                     ??simplemeter_ProcessZDOMsgs_0:
   \   000038   1A17         POPM.W  #0x2, R11
   \   00003A   1001         RETA
    488          
    489          /*********************************************************************
    490           * @fn      simplemeter_ProcessIdentifyTimeChange
    491           *
    492           * @brief   Called to blink led for specified IdentifyTime attribute value
    493           *
    494           * @param   none
    495           *
    496           * @return  none
    497           */

   \                                 In  segment CODE, align 2
    498          static void simplemeter_ProcessIdentifyTimeChange( void )
   \                     simplemeter_ProcessIdentifyTimeChange:
    499          {
    500            if ( simpleMeterIdentifyTime > 0 )
   \   000000   8293....     CMP.W   #0x0, &simpleMeterIdentifyTime
   \   000004   0F24         JEQ     ??simplemeter_ProcessIdentifyTimeChange_0
    501            {
    502              osal_start_timerEx( simpleMeterTaskID, SIMPLEMETER_IDENTIFY_TIMEOUT_EVT, 1000 );
   \   000006   3E40E803     MOV.W   #0x3e8, R14
   \   00000A   1D43         MOV.W   #0x1, R13
   \   00000C   5C42....     MOV.B   &simpleMeterTaskID, R12
   \   000010   ........     CALLA   #osal_start_timerEx
    503              HalLedBlink ( HAL_LED_4, 0xFF, HAL_LED_DEFAULT_DUTY_CYCLE, HAL_LED_DEFAULT_FLASH_TIME );
   \   000014   3F40E803     MOV.W   #0x3e8, R15
   \   000018   7E400500     MOV.B   #0x5, R14
   \   00001C   7D43         MOV.B   #0xff, R13
   \   00001E   7C42         MOV.B   #0x8, R12
   \   000020   ........     BRA     #HalLedBlink
    504            }
    505            else
    506            {
    507              HalLedSet ( HAL_LED_4, HAL_LED_MODE_OFF );
   \                     ??simplemeter_ProcessIdentifyTimeChange_0:
   \   000024   4D43         MOV.B   #0x0, R13
   \   000026   7C42         MOV.B   #0x8, R12
   \   000028   ........     CALLA   #HalLedSet
    508              osal_stop_timerEx( simpleMeterTaskID, SIMPLEMETER_IDENTIFY_TIMEOUT_EVT );
   \   00002C   1D43         MOV.W   #0x1, R13
   \   00002E   5C42....     MOV.B   &simpleMeterTaskID, R12
   \   000032   ........     BRA     #osal_stop_timerEx
    509            }
    510          }
    511          
    512          #if SECURE
    513          /*********************************************************************
    514           * @fn      simplemeter_KeyEstablish_ReturnLinkKey
    515           *
    516           * @brief   This function get the requested link key
    517           *
    518           * @param   shortAddr - short address of the partner.
    519           *
    520           * @return  none
    521           */
    522          static uint8 simplemeter_KeyEstablish_ReturnLinkKey( uint16 shortAddr )
    523          {
    524            uint8 status = ZFailure;
    525            AddrMgrEntry_t entry;
    526          
    527            // Look up the long address of the device
    528          
    529            entry.user = ADDRMGR_USER_DEFAULT;
    530            entry.nwkAddr = shortAddr;
    531          
    532            if ( AddrMgrEntryLookupNwk( &entry ) )
    533            {
    534              // check if APS link key has been established
    535              if ( APSME_IsLinkKeyValid( entry.extAddr ) == TRUE )
    536              {
    537                status = ZSuccess;
    538              }
    539            }
    540            else
    541            {
    542              // It's an unknown device
    543              status = ZInvalidParameter;
    544            }
    545          
    546            return status;
    547          }
    548          #endif
    549          
    550          /*********************************************************************
    551           * @fn      simplemeter_HandleKeys
    552           *
    553           * @brief   Handles all key events for this device.
    554           *
    555           * @param   shift - true if in shift/alt.
    556           * @param   keys - bit field for key events. Valid entries:
    557           *                 HAL_KEY_SW_4
    558           *                 HAL_KEY_SW_3
    559           *                 HAL_KEY_SW_2
    560           *                 HAL_KEY_SW_1
    561           *
    562           * @return  none
    563           */
    564          static void simplemeter_HandleKeys( uint8 shift, uint8 keys )
    565          {
    566            // Shift is used to make each button/switch dual purpose.
    567            if ( shift )
    568            {
    569              if ( keys & HAL_KEY_SW_1 )
    570              {
    571              }
    572              if ( keys & HAL_KEY_SW_2 )
    573              {
    574              }
    575              if ( keys & HAL_KEY_SW_3 )
    576              {
    577              }
    578              if ( keys & HAL_KEY_SW_4 )
    579              {
    580              }
    581            }
    582            else
    583            {
    584              if ( keys & HAL_KEY_SW_1 )
    585              {
    586                ZDOInitDevice(0);  // Join the network.
    587              }
    588          
    589              if ( keys & HAL_KEY_SW_2 )
    590              {
    591          
    592              }
    593          
    594              if ( keys & HAL_KEY_SW_3 )
    595              {
    596          
    597              }
    598          
    599              if ( keys & HAL_KEY_SW_4 )
    600              {
    601          
    602              }
    603            }
    604          }
    605          
    606          /*********************************************************************
    607           * @fn      simplemeter_ValidateAttrDataCB
    608           *
    609           * @brief   Check to see if the supplied value for the attribute data
    610           *          is within the specified range of the attribute.
    611           *
    612           * @param   pAttr - pointer to attribute
    613           * @param   pAttrInfo - pointer to attribute info
    614           *
    615           * @return  TRUE if data valid. FALSE otherwise.
    616           */

   \                                 In  segment CODE, align 2
    617          static uint8 simplemeter_ValidateAttrDataCB( zclAttrRec_t *pAttr, zclWriteRec_t *pAttrInfo )
   \                     simplemeter_ValidateAttrDataCB:
    618          {
    619            uint8 valid = TRUE;
   \   000000   5C43         MOV.B   #0x1, R12
    620          
    621            switch ( pAttrInfo->dataType )
   \   000002   FD9010000200 CMP.B   #0x10, 0x2(R13)
   \   000008   0820         JNE     ??simplemeter_ValidateAttrDataCB_0
    622            {
    623              case ZCL_DATATYPE_BOOLEAN:
    624                if ( ( *(pAttrInfo->attrData) != 0 ) && ( *(pAttrInfo->attrData) != 1 ) )
   \   00000A   1F4D0400     MOV.W   0x4(R13), R15
   \   00000E   6E4F         MOV.B   @R15, R14
   \   000010   4E93         CMP.B   #0x0, R14
   \   000012   0324         JEQ     ??simplemeter_ValidateAttrDataCB_0
   \   000014   5E93         CMP.B   #0x1, R14
   \   000016   0124         JEQ     ??simplemeter_ValidateAttrDataCB_0
    625                  valid = FALSE;
   \   000018   4C43         MOV.B   #0x0, R12
    626                break;
    627          
    628              default:
    629                break;
    630            }
    631          
    632            return ( valid );
   \                     ??simplemeter_ValidateAttrDataCB_0:
   \   00001A   1001         RETA
    633          }
    634          
    635          /*********************************************************************
    636           * @fn      simplemeter_BasicResetCB
    637           *
    638           * @brief   Callback from the ZCL General Cluster Library to set all
    639           *          the attributes of all the clusters to their factory defaults
    640           *
    641           * @param   none
    642           *
    643           * @return  none
    644           */

   \                                 In  segment CODE, align 2
    645          static void simplemeter_BasicResetCB( void )
   \                     simplemeter_BasicResetCB:
    646          {
    647            // user should handle setting attributes to factory defaults here
    648          }
   \   000000   1001         RETA
    649          
    650          /*********************************************************************
    651           * @fn      simplemeter_IdentifyCB
    652           *
    653           * @brief   Callback from the ZCL General Cluster Library when
    654           *          it received an Identity Command for this application.
    655           *
    656           * @param   pCmd - pointer to structure for identify command
    657           *
    658           * @return  none
    659           */

   \                                 In  segment CODE, align 2
    660          static void simplemeter_IdentifyCB( zclIdentify_t *pCmd )
   \                     simplemeter_IdentifyCB:
    661          {
    662            simpleMeterIdentifyTime = pCmd->identifyTime;
   \   000000   924C0200.... MOV.W   0x2(R12), &simpleMeterIdentifyTime
    663            simplemeter_ProcessIdentifyTimeChange();
   \   000006   ........     BRA     #simplemeter_ProcessIdentifyTimeChange
    664          }
    665          
    666          /*********************************************************************
    667           * @fn      simplemeter_IdentifyQueryRspCB
    668           *
    669           * @brief   Callback from the ZCL General Cluster Library when
    670           *          it received an Identity Query Response Command for this application.
    671           *
    672           * @param   pRsp - pointer to structure for identify query response
    673           *
    674           * @return  none
    675           */

   \                                 In  segment CODE, align 2
    676          static void simplemeter_IdentifyQueryRspCB( zclIdentifyQueryRsp_t *pRsp )
   \                     simplemeter_IdentifyQueryRspCB:
    677          {
    678            // add user code here
    679          }
   \   000000   1001         RETA
    680          
    681          
    682          
    683          /*********************************************************************
    684           * @fn      simplemeter_AlarmCB
    685           *
    686           * @brief   Callback from the ZCL General Cluster Library when
    687           *          it received an Alarm request or response command for
    688           *          this application.
    689           *
    690           * @param   pAlarm - pointer to structure for alarm command
    691           *
    692           * @return  none
    693           */

   \                                 In  segment CODE, align 2
    694          static void simplemeter_AlarmCB( zclAlarm_t *pAlarm )
   \                     simplemeter_AlarmCB:
    695          {
    696            // add user code here
    697          }
   \   000000   1001         RETA
    698          
    699          /*********************************************************************
    700           * @fn      simplemeter_GetProfileCmdCB
    701           *
    702           * @brief   Callback from the ZCL SE Profile Simple Metering Cluster Library when
    703           *          it received a Get Profile Command for
    704           *          this application.
    705           *
    706           * @param   pCmd - pointer to get profile command structure
    707           * @param   srcAddr - pointer to source address
    708           * @param   seqNum - sequence number of this command
    709           *
    710           * @return  none
    711           */

   \                                 In  segment CODE, align 2
    712          static void simplemeter_GetProfileCmdCB( zclCCGetProfileCmd_t *pCmd, afAddrType_t *srcAddr, uint8 seqNum )
   \                     simplemeter_GetProfileCmdCB:
    713          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   31801400     SUB.W   #0x14, SP
   \   000006   0A4C         MOV.W   R12, R10
   \   000008   0B4D         MOV.W   R13, R11
   \   00000A   4F4E         MOV.B   R14, R15
    714          #if defined ( ZCL_SIMPLE_METERING )
    715            // Upon receipt of the Get Profile Command, the metering device shall send
    716            // Get Profile Response back.
    717          
    718            // Variables in the following are initialized to arbitrary value for test purpose
    719            // In real application, user shall look up the interval data captured during
    720            // the period specified in the pCmd->endTime and return corresponding data.
    721          
    722            uint32 endTime;
    723            uint8  status = zclSE_SimpleMeter_GetProfileRsp_Status_Success;
    724            uint8  profileIntervalPeriod = PROFILE_INTERVAL_PERIOD_60MIN;
    725            uint8  numberOfPeriodDelivered = 5;
    726            uint24 intervals[] = {0xa00001, 0xa00002, 0xa00003, 0xa00004, 0xa00005};
   \   00000C   0C41         MOV.W   SP, R12
   \   00000E   3E40....     MOV.W   #`?<Constant {10485761L, 10485762L, 10485763L, 1`, R14
   \   000012   3D400A00     MOV.W   #0xa, R13
   \   000016   ........     CALLA   #?CopyMemoryWords
    727          
    728            // endTime: 32 bit value (in UTC) representing the end time of the most
    729            // chronologically recent interval being requested.
    730            // Example: Data collected from 2:00 PM to 3:00 PM would be specified as a
    731            // 3:00 PM interval (end time).
    732          
    733            // The Intervals block returned shall be the most recent block with
    734            // its EndTime equal or older to the one in the request (pCmd->endTime).
    735            // Requested End Time with value 0xFFFFFFFF indicats the most recent
    736            // Intervals block is requested.
    737          
    738            // Sample Code - assuming the end time of the requested block is the same as
    739            // it in the request.
    740            endTime = pCmd->endTime;
    741          
    742            // Send Get Profile Response Command back
    743          
    744            zclSE_SimpleMetering_Send_GetProfileRsp( SIMPLEMETER_ENDPOINT, srcAddr, endTime,
    745                                                     status,
    746                                                     profileIntervalPeriod,
    747                                                     numberOfPeriodDelivered, intervals,
    748                                                     FALSE, seqNum );
   \   00001A   4F12         PUSH.B  R15
   \   00001C   4312         PUSH.B  #0x0
   \   00001E   0F41         MOV.W   SP, R15
   \   000020   2F52         ADD.W   #0x4, R15
   \   000022   0F12         PUSH.W  R15
   \   000024   70120500     PUSH.B  #0x5
   \   000028   5312         PUSH.B  #0x1
   \   00002A   4312         PUSH.B  #0x0
   \   00002C   1E4A0200     MOV.W   0x2(R10), R14
   \   000030   1F4A0400     MOV.W   0x4(R10), R15
   \   000034   0D4B         MOV.W   R11, R13
   \   000036   7C400900     MOV.B   #0x9, R12
   \   00003A   ........     CALLA   #zclSE_SimpleMetering_Send_GetProfileRsp
    749          #endif // ZCL_SIMPLE_METERING
    750          }
   \   00003E   31502000     ADD.W   #0x20, SP
   \   000042   1A17         POPM.W  #0x2, R11
   \   000044   1001         RETA
    751          
    752          /*********************************************************************
    753           * @fn      simplemeter_GetProfileRspCB
    754           *
    755           * @brief   Callback from the ZCL SE Profile Simple Metering Cluster Library when
    756           *          it received a Get Profile Response for
    757           *          this application.
    758           *
    759           * @param   pCmd - pointer to get profile response structure
    760           * @param   srcAddr - pointer to source address
    761           * @param   seqNum - sequence number of this command
    762           *
    763           * @return  none
    764           */

   \                                 In  segment CODE, align 2
    765          static void simplemeter_GetProfileRspCB( zclCCGetProfileRsp_t *pCmd, afAddrType_t *srcAddr, uint8 seqNum )
   \                     simplemeter_GetProfileRspCB:
    766          {
    767            // add user code here
    768          }
   \   000000   1001         RETA
    769          
    770          /*********************************************************************
    771           * @fn      simplemeter_ReqMirrorCmdCB
    772           *
    773           * @brief   Callback from the ZCL SE Profile Simple Metering Cluster Library when
    774           *          it received a Request Mirror Command for
    775           *          this application.
    776           *
    777           * @param   srcAddr - pointer to source address
    778           * @param   seqNum - sequence number of this command
    779           *
    780           * @return  none
    781           */

   \                                 In  segment CODE, align 2
    782          static void simplemeter_ReqMirrorCmdCB( afAddrType_t *srcAddr, uint8 seqNum )
   \                     simplemeter_ReqMirrorCmdCB:
    783          {
    784            // add user code here
    785          }
   \   000000   1001         RETA
    786          /*********************************************************************
    787           * @fn      simplemeter_ReqMirrorRspCB
    788           *
    789           * @brief   Callback from the ZCL SE Profile Simple Metering Cluster Library when
    790           *          it received a Request Mirror Response for
    791           *          this application.
    792           *
    793           * @param   pRsp - pointer to request mirror response structure
    794           * @param   srcAddr - pointer to source address
    795           * @param   seqNum - sequence number of this command
    796           *
    797           * @return  none
    798           */

   \                                 In  segment CODE, align 2
    799          static void simplemeter_ReqMirrorRspCB( zclCCReqMirrorRsp_t *pRsp, afAddrType_t *srcAddr, uint8 seqNum )
   \                     simplemeter_ReqMirrorRspCB:
    800          {
    801            // add user code here
    802          }
   \   000000   1001         RETA
    803          /*********************************************************************
    804           * @fn      simplemeter_MirrorRemCmdCB
    805           *
    806           * @brief   Callback from the ZCL SE Profile Simple Metering Cluster Library when
    807           *          it received a Mirror Remove Command for
    808           *          this application.
    809           *
    810           * @param   srcAddr - pointer to source address
    811           * @param   seqNum - sequence number of this command
    812           *
    813           * @return  none
    814           */

   \                                 In  segment CODE, align 2
    815          static void simplemeter_MirrorRemCmdCB( afAddrType_t *srcAddr, uint8 seqNum )
   \                     simplemeter_MirrorRemCmdCB:
    816          {
    817           // add user code here
    818          }
   \   000000   1001         RETA
    819          /*********************************************************************
    820           * @fn      simplemeter_MirrorRemRspCB
    821           *
    822           * @brief   Callback from the ZCL SE Profile Simple Metering Cluster Library when
    823           *          it received a Mirror Remove Response for
    824           *          this application.
    825           *
    826           * @param   pCmd - pointer to mirror remove response structure
    827           * @param   srcAddr - pointer to source address
    828           * @param   seqNum - sequence number of this command
    829           *
    830           * @return  none
    831           */

   \                                 In  segment CODE, align 2
    832          static void simplemeter_MirrorRemRspCB( zclCCMirrorRemRsp_t *pCmd, afAddrType_t *srcAddr, uint8 seqNum )
   \                     simplemeter_MirrorRemRspCB:
    833          {
    834            // add user code here
    835          }
   \   000000   1001         RETA
    836          
    837          
    838          /******************************************************************************
    839           *
    840           *  Functions for processing ZCL Foundation incoming Command/Response messages
    841           *
    842           *****************************************************************************/
    843          
    844          /*********************************************************************
    845           * @fn      simplemeter_ProcessZCLMsg
    846           *
    847           * @brief   Process ZCL Foundation incoming message
    848           *
    849           * @param   pInMsg - message to process
    850           *
    851           * @return  none
    852           */

   \                                 In  segment CODE, align 2
    853          static void simplemeter_ProcessZCLMsg( zclIncomingMsg_t *pInMsg )
   \                     simplemeter_ProcessZCLMsg:
    854          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   0A4C         MOV.W   R12, R10
    855            switch ( pInMsg->zclHdr.commandID )
   \   000004   0B4C         MOV.W   R12, R11
   \   000006   3B501800     ADD.W   #0x18, R11
   \   00000A   5E4C0700     MOV.B   0x7(R12), R14
   \   00000E   5E83         SUB.B   #0x1, R14
   \   000010   0E24         JEQ     ??simplemeter_ProcessZCLMsg_4
   \   000012   7E800300     SUB.B   #0x3, R14
   \   000016   1124         JEQ     ??simplemeter_ProcessZCLMsg_5
   \   000018   6E83         SUB.B   #0x2, R14
   \   00001A   1524         JEQ     ??simplemeter_ProcessZCLMsg_6
   \   00001C   5E83         SUB.B   #0x1, R14
   \   00001E   1624         JEQ     ??simplemeter_ProcessZCLMsg_7
   \   000020   5E83         SUB.B   #0x1, R14
   \   000022   1724         JEQ     ??simplemeter_ProcessZCLMsg_8
   \   000024   5E83         SUB.B   #0x1, R14
   \   000026   1824         JEQ     ??simplemeter_ProcessZCLMsg_9
   \   000028   5E83         SUB.B   #0x1, R14
   \   00002A   1C24         JEQ     ??simplemeter_ProcessZCLMsg_10
   \   00002C   213C         JMP     ??simplemeter_ProcessZCLMsg_11
    856            {
    857          #if defined ( ZCL_READ )
    858              case ZCL_CMD_READ_RSP:
    859                simplemeter_ProcessInReadRspCmd( pInMsg );
   \                     ??simplemeter_ProcessZCLMsg_4:
   \   00002E   2F4B         MOV.W   @R11, R15
   \   000030   4E43         MOV.B   #0x0, R14
   \                     ??simplemeter_ProcessZCLMsg_0:
   \   000032   6E9F         CMP.B   @R15, R14
   \   000034   1D2C         JC      ??simplemeter_ProcessZCLMsg_11
   \   000036   5E53         ADD.B   #0x1, R14
   \   000038   FC3F         JMP     ??simplemeter_ProcessZCLMsg_0
    860                break;
    861          #endif // ZCL_READ
    862          #if defined ( ZCL_WRITE )
    863              case ZCL_CMD_WRITE_RSP:
    864                simplemeter_ProcessInWriteRspCmd( pInMsg );
   \                     ??simplemeter_ProcessZCLMsg_5:
   \   00003A   2F4B         MOV.W   @R11, R15
   \   00003C   4E43         MOV.B   #0x0, R14
   \                     ??simplemeter_ProcessZCLMsg_1:
   \   00003E   6E9F         CMP.B   @R15, R14
   \   000040   172C         JC      ??simplemeter_ProcessZCLMsg_11
   \   000042   5E53         ADD.B   #0x1, R14
   \   000044   FC3F         JMP     ??simplemeter_ProcessZCLMsg_1
    865                break;
    866          #endif // ZCL_READ
    867          #if defined ( ZCL_REPORT )
    868              case ZCL_CMD_CONFIG_REPORT:
    869                simplemeter_ProcessInConfigReportCmd( pInMsg );
   \                     ??simplemeter_ProcessZCLMsg_6:
   \   000046   ........     CALLA   #simplemeter_ProcessInConfigReportCmd
    870                break;
   \   00004A   123C         JMP     ??simplemeter_ProcessZCLMsg_11
    871          
    872              case ZCL_CMD_CONFIG_REPORT_RSP:
    873                simplemeter_ProcessInConfigReportRspCmd( pInMsg );
   \                     ??simplemeter_ProcessZCLMsg_7:
   \   00004C   ........     CALLA   #simplemeter_ProcessInConfigReportRspCmd
    874                break;
   \   000050   0F3C         JMP     ??simplemeter_ProcessZCLMsg_11
    875          
    876              case ZCL_CMD_READ_REPORT_CFG:
    877                simplemeter_ProcessInReadReportCfgCmd( pInMsg );
   \                     ??simplemeter_ProcessZCLMsg_8:
   \   000052   ........     CALLA   #simplemeter_ProcessInReadReportCfgCmd
    878                break;
   \   000056   0C3C         JMP     ??simplemeter_ProcessZCLMsg_11
    879          
    880              case ZCL_CMD_READ_REPORT_CFG_RSP:
    881                simplemeter_ProcessInReadReportCfgRspCmd( pInMsg );
   \                     ??simplemeter_ProcessZCLMsg_9:
   \   000058   2F4B         MOV.W   @R11, R15
   \   00005A   4E43         MOV.B   #0x0, R14
   \                     ??simplemeter_ProcessZCLMsg_2:
   \   00005C   6E9F         CMP.B   @R15, R14
   \   00005E   082C         JC      ??simplemeter_ProcessZCLMsg_11
   \   000060   5E53         ADD.B   #0x1, R14
   \   000062   FC3F         JMP     ??simplemeter_ProcessZCLMsg_2
    882                break;
    883          
    884              case ZCL_CMD_REPORT:
    885                simplemeter_ProcessInReportCmd( pInMsg );
   \                     ??simplemeter_ProcessZCLMsg_10:
   \   000064   2F4B         MOV.W   @R11, R15
   \   000066   4E43         MOV.B   #0x0, R14
   \   000068   013C         JMP     ??simplemeter_ProcessZCLMsg_12
   \                     ??simplemeter_ProcessZCLMsg_3:
   \   00006A   5E53         ADD.B   #0x1, R14
   \                     ??simplemeter_ProcessZCLMsg_12:
   \   00006C   6E9F         CMP.B   @R15, R14
   \   00006E   FD2B         JNC     ??simplemeter_ProcessZCLMsg_3
   \                     ??simplemeter_ProcessZCLMsg_11:
   \   000070   8A931800     CMP.W   #0x0, 0x18(R10)
   \   000074   0524         JEQ     ??simplemeter_ProcessZCLMsg_13
    886                break;
    887          #endif // ZCL_REPORT
    888              case ZCL_CMD_DEFAULT_RSP:
    889                simplemeter_ProcessInDefaultRspCmd( pInMsg );
    890                break;
    891          #if defined ( ZCL_DISCOVER )
    892              case ZCL_CMD_DISCOVER_RSP:
    893                simplemeter_ProcessInDiscRspCmd( pInMsg );
    894                break;
    895          #endif // ZCL_DISCOVER
    896              default:
    897                break;
    898            }
    899          
    900            if ( pInMsg->attrCmd != NULL )
    901            {
    902              // free the parsed command
    903              osal_mem_free( pInMsg->attrCmd );
   \   000076   2C4B         MOV.W   @R11, R12
   \   000078   ........     CALLA   #osal_mem_free
    904              pInMsg->attrCmd = NULL;
   \   00007C   8A431800     MOV.W   #0x0, 0x18(R10)
    905            }
    906          }
   \                     ??simplemeter_ProcessZCLMsg_13:
   \   000080   1A17         POPM.W  #0x2, R11
   \   000082   1001         RETA
    907          
    908          #if defined ( ZCL_READ )
    909          /*********************************************************************
    910           * @fn      simplemeter_ProcessInReadRspCmd
    911           *
    912           * @brief   Process the "Profile" Read Response Command
    913           *
    914           * @param   pInMsg - incoming message to process
    915           *
    916           * @return  none
    917           */
    918          static uint8 simplemeter_ProcessInReadRspCmd( zclIncomingMsg_t *pInMsg )
    919          {
    920            zclReadRspCmd_t *readRspCmd;
    921            uint8 i;
    922          
    923            readRspCmd = (zclReadRspCmd_t *)pInMsg->attrCmd;
    924            for (i = 0; i < readRspCmd->numAttr; i++)
    925            {
    926              // Notify the originator of the results of the original read attributes
    927              // attempt and, for each successfull request, the value of the requested
    928              // attribute
    929            }
    930          
    931            return TRUE;
    932          }
    933          #endif // ZCL_READ
    934          
    935          #if defined ( ZCL_WRITE )
    936          /*********************************************************************
    937           * @fn      simplemeter_ProcessInWriteRspCmd
    938           *
    939           * @brief   Process the "Profile" Write Response Command
    940           *
    941           * @param   pInMsg - incoming message to process
    942           *
    943           * @return  none
    944           */
    945          static uint8 simplemeter_ProcessInWriteRspCmd( zclIncomingMsg_t *pInMsg )
    946          {
    947            zclWriteRspCmd_t *writeRspCmd;
    948            uint8 i;
    949          
    950            writeRspCmd = (zclWriteRspCmd_t *)pInMsg->attrCmd;
    951            for (i = 0; i < writeRspCmd->numAttr; i++)
    952            {
    953              // Notify the device of the results of the its original write attributes
    954              // command.
    955            }
    956          
    957            return TRUE;
    958          }
    959          #endif // ZCL_WRITE
    960          
    961          #if defined ( ZCL_REPORT )
    962          /*********************************************************************
    963           * @fn      simplemeter_ProcessInConfigReportCmd
    964           *
    965           * @brief   Process the "Profile" Configure Reporting Command
    966           *
    967           * @param   pInMsg - incoming message to process
    968           *
    969           * @return  TRUE if attribute was found in the Attribute list,
    970           *          FALSE if not
    971           */

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine0:
   \   000000   3152         ADD.W   #0x8, SP
   \   000002   5617         POPM.W  #0x6, R11
   \   000004   1001         RETA

   \                                 In  segment CODE, align 2
    972          static uint8 simplemeter_ProcessInConfigReportCmd( zclIncomingMsg_t *pInMsg )
   \                     simplemeter_ProcessInConfigReportCmd:
    973          {
   \   000000   5B15         PUSHM.W #0x6, R11
   \   000002   3182         SUB.W   #0x8, SP
   \   000004   084C         MOV.W   R12, R8
    974            zclCfgReportCmd_t *cfgReportCmd;
    975            zclCfgReportRec_t *reportRec;
    976            zclCfgReportRspCmd_t *cfgReportRspCmd;
    977            zclAttrRec_t attrRec;
    978            uint8 status;
    979            uint8 i, j = 0;
   \   000006   4A43         MOV.B   #0x0, R10
    980          
    981            cfgReportCmd = (zclCfgReportCmd_t *)pInMsg->attrCmd;
   \   000008   194C1800     MOV.W   0x18(R12), R9
    982          
    983            // Allocate space for the response command
    984            cfgReportRspCmd = (zclCfgReportRspCmd_t *)osal_mem_alloc( sizeof ( zclCfgReportRspCmd_t ) + \
    985                                                  sizeof ( zclCfgReportStatus_t) * cfgReportCmd->numAttr );
   \   00000C   6C49         MOV.B   @R9, R12
   \   00000E   5C06         RLAM.W  #0x2, R12
   \   000010   2C53         ADD.W   #0x2, R12
   \   000012   ........     CALLA   #osal_mem_alloc
   \   000016   064C         MOV.W   R12, R6
    986            if ( cfgReportRspCmd == NULL )
   \   000018   0C93         CMP.W   #0x0, R12
   \   00001A   0220         JNE     ??simplemeter_ProcessInConfigReportCmd_3
    987              return FALSE; // EMBEDDED RETURN
   \   00001C   4C43         MOV.B   #0x0, R12
   \   00001E   473C         JMP     ??simplemeter_ProcessInConfigReportCmd_4
    988          
    989            // Process each Attribute Reporting Configuration record
    990            for ( i = 0; i < cfgReportCmd->numAttr; i++ )
   \                     ??simplemeter_ProcessInConfigReportCmd_3:
   \   000020   4B43         MOV.B   #0x0, R11
   \   000022   0D3C         JMP     ??simplemeter_ProcessInConfigReportCmd_5
    991            {
    992              reportRec = &(cfgReportCmd->attrList[i]);
    993          
    994              status = ZCL_STATUS_SUCCESS;
    995          
    996              if ( zclFindAttrRec( SIMPLEMETER_ENDPOINT, pInMsg->clusterId, reportRec->attrID, &attrRec ) )
    997              {
    998                if ( reportRec->direction == ZCL_SEND_ATTR_REPORTS )
    999                {
   1000                  if ( reportRec->dataType == attrRec.attr.dataType )
   1001                  {
   1002                    // This the attribute that is to be reported
   1003                    if ( zcl_MandatoryReportableAttribute( &attrRec ) == TRUE )
   1004                    {
   1005                      if ( reportRec->minReportInt < SIMPLEMETER_MIN_REPORTING_INTERVAL ||
   1006                           ( reportRec->maxReportInt != 0 &&
   1007                             reportRec->maxReportInt < reportRec->minReportInt ) )
   1008                      {
   1009                        // Invalid fields
   1010                        status = ZCL_STATUS_INVALID_VALUE;
   1011                      }
   1012                      else
   1013                      {
   1014                        // Set the Min and Max Reporting Intervals and Reportable Change
   1015                        //status = zclSetAttrReportInterval( pAttr, cfgReportCmd );
   1016                        status = ZCL_STATUS_UNREPORTABLE_ATTRIBUTE; // for now
   1017                      }
   1018                    }
   1019                    else
   1020                    {
   1021                      // Attribute cannot be reported
   1022                      status = ZCL_STATUS_UNREPORTABLE_ATTRIBUTE;
   1023                    }
   1024                  }
   1025                  else
   1026                  {
   1027                    // Attribute data type is incorrect
   1028                    status = ZCL_STATUS_INVALID_DATA_TYPE;
   1029                  }
   1030                }
   1031                else
   1032                {
   1033                  // We shall expect reports of values of this attribute
   1034                  if ( zcl_MandatoryReportableAttribute( &attrRec ) == TRUE )
   1035                  {
   1036                    // Set the Timeout Period
   1037                    //status = zclSetAttrTimeoutPeriod( pAttr, cfgReportCmd );
   1038                    status = ZCL_STATUS_UNSUPPORTED_ATTRIBUTE; // for now
   1039                  }
   1040                  else
   1041                  {
   1042                    // Reports of attribute cannot be received
   1043                    status = ZCL_STATUS_UNSUPPORTED_ATTRIBUTE;
   1044                  }
   1045                }
   1046              }
   1047              else
   1048              {
   1049                // Attribute is not supported
   1050                status = ZCL_STATUS_UNSUPPORTED_ATTRIBUTE;
   \                     ??simplemeter_ProcessInConfigReportCmd_0:
   \   000024   7E408600     MOV.B   #0x86, R14
   1051              }
   1052          
   1053              // If not successful then record the status
   1054              if ( status != ZCL_STATUS_SUCCESS )
   1055              {
   1056                cfgReportRspCmd->attrList[j].status = status;
   \                     ??simplemeter_ProcessInConfigReportCmd_1:
   \   000028   4D4A         MOV.B   R10, R13
   \   00002A   5D06         RLAM.W  #0x2, R13
   \   00002C   0F46         MOV.W   R6, R15
   \   00002E   0F5D         ADD.W   R13, R15
   \   000030   CF4E0200     MOV.B   R14, 0x2(R15)
   1057                cfgReportRspCmd->attrList[j++].attrID = reportRec->attrID;
   \   000034   9F4702000400 MOV.W   0x2(R7), 0x4(R15)
   \   00003A   5A53         ADD.B   #0x1, R10
   1058              }
   \   00003C   5B53         ADD.B   #0x1, R11
   \                     ??simplemeter_ProcessInConfigReportCmd_5:
   \   00003E   6B99         CMP.B   @R9, R11
   \   000040   192C         JC      ??simplemeter_ProcessInConfigReportCmd_6
   \   000042   0F4B         MOV.W   R11, R15
   \   000044                RPT     #0xd
   \   000044   4C180F5B     ADDX.W  R11, R15
   \   000048   0749         MOV.W   R9, R7
   \   00004A   075F         ADD.W   R15, R7
   \   00004C   2753         ADD.W   #0x2, R7
   \   00004E   0F41         MOV.W   SP, R15
   \   000050   1E470200     MOV.W   0x2(R7), R14
   \   000054   ........     CALLA   #?Subroutine1
   \                     ??CrossCallReturnLabel_3:
   \   000058   E527         JEQ     ??simplemeter_ProcessInConfigReportCmd_0
   \   00005A   C7930000     CMP.B   #0x0, 0(R7)
   \   00005E   E223         JNE     ??simplemeter_ProcessInConfigReportCmd_0
   \   000060   D79104000400 CMP.B   0x4(SP), 0x4(R7)
   \   000066   0324         JEQ     ??simplemeter_ProcessInConfigReportCmd_7
   \   000068   7E408D00     MOV.B   #0x8d, R14
   \   00006C   DD3F         JMP     ??simplemeter_ProcessInConfigReportCmd_1
   \                     ??simplemeter_ProcessInConfigReportCmd_7:
   \   00006E   7E408C00     MOV.B   #0x8c, R14
   \   000072   DA3F         JMP     ??simplemeter_ProcessInConfigReportCmd_1
   1059            } // for loop
   1060          
   1061            if ( j == 0 )
   \                     ??simplemeter_ProcessInConfigReportCmd_6:
   \   000074   4A93         CMP.B   #0x0, R10
   \   000076   0520         JNE     ??simplemeter_ProcessInConfigReportCmd_8
   1062            {
   1063              // Since all attributes were configured successfully, include a single
   1064              // attribute status record in the response command with the status field
   1065              // set to SUCCESS and the attribute ID field omitted.
   1066              cfgReportRspCmd->attrList[0].status = ZCL_STATUS_SUCCESS;
   \   000078   C6430200     MOV.B   #0x0, 0x2(R6)
   1067              cfgReportRspCmd->numAttr = 1;
   \   00007C   D6430000     MOV.B   #0x1, 0(R6)
   \   000080   023C         JMP     ??simplemeter_ProcessInConfigReportCmd_9
   1068            }
   1069            else
   1070            {
   1071              cfgReportRspCmd->numAttr = j;
   \                     ??simplemeter_ProcessInConfigReportCmd_8:
   \   000082   C64A0000     MOV.B   R10, 0(R6)
   1072            }
   1073          
   1074            // Send the response back
   1075            zcl_SendConfigReportRspCmd( SIMPLEMETER_ENDPOINT, &(pInMsg->srcAddr),
   1076                                        pInMsg->clusterId, cfgReportRspCmd, ZCL_FRAME_SERVER_CLIENT_DIR,
   1077                                        TRUE, pInMsg->zclHdr.transSeqNum );
   \                     ??simplemeter_ProcessInConfigReportCmd_9:
   \   000086   58120600     PUSH.B  0x6(R8)
   \   00008A   5312         PUSH.B  #0x1
   \   00008C   5312         PUSH.B  #0x1
   \   00008E   0F46         MOV.W   R6, R15
   \   000090   1E480800     MOV.W   0x8(R8), R14
   \   000094   38500A00     ADD.W   #0xa, R8
   \   000098   0D48         MOV.W   R8, R13
   \   00009A   7C400900     MOV.B   #0x9, R12
   \   00009E   ........     CALLA   #zcl_SendConfigReportRspCmd
   1078            osal_mem_free( cfgReportRspCmd );
   \   0000A2   0C46         MOV.W   R6, R12
   \   0000A4   ........     CALLA   #osal_mem_free
   1079          
   1080            return TRUE ;
   \   0000A8   5C43         MOV.B   #0x1, R12
   \   0000AA   31500600     ADD.W   #0x6, SP
   \                     ??simplemeter_ProcessInConfigReportCmd_4:
   \   0000AE   ....         JMP     ?Subroutine0
   \   0000B0   0343         NOP
   1081          }

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine1:
   \   000000   1D480800     MOV.W   0x8(R8), R13
   \   000004                REQUIRE ??Subroutine3_0
   \   000004                // Fall through to label ??Subroutine3_0

   \                                 In  segment CODE, align 2
   \                     ??Subroutine3_0:
   \   000000   7C400900     MOV.B   #0x9, R12
   \   000004   ........     CALLA   #zclFindAttrRec
   \   000008   4C93         CMP.B   #0x0, R12
   \   00000A   1001         RETA
   1082          
   1083          /*********************************************************************
   1084           * @fn      simplemeter_ProcessInConfigReportRspCmd
   1085           *
   1086           * @brief   Process the "Profile" Configure Reporting Response Command
   1087           *
   1088           * @param   pInMsg - incoming message to process
   1089           *
   1090           * @return  none
   1091           */

   \                                 In  segment CODE, align 2, keep-with-next
   1092          static uint8 simplemeter_ProcessInConfigReportRspCmd( zclIncomingMsg_t *pInMsg )
   \                     simplemeter_ProcessInConfigReportRspCmd:
   1093          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   3182         SUB.W   #0x8, SP
   \   000004   0B4C         MOV.W   R12, R11
   1094            zclCfgReportRspCmd_t *cfgReportRspCmd;
   1095            zclAttrRec_t attrRec;
   1096            uint8 i;
   1097          
   1098            cfgReportRspCmd = (zclCfgReportRspCmd_t *)pInMsg->attrCmd;
   \   000006   184C1800     MOV.W   0x18(R12), R8
   1099            for (i = 0; i < cfgReportRspCmd->numAttr; i++)
   \   00000A   4A43         MOV.B   #0x0, R10
   \   00000C   0E3C         JMP     ??simplemeter_ProcessInConfigReportRspCmd_1
   1100            {
   1101              if ( zclFindAttrRec( SIMPLEMETER_ENDPOINT, pInMsg->clusterId,
   1102                                   cfgReportRspCmd->attrList[i].attrID, &attrRec ) )
   \                     ??simplemeter_ProcessInConfigReportRspCmd_0:
   \   00000E   0F41         MOV.W   SP, R15
   \   000010   4E4A         MOV.B   R10, R14
   \   000012   5E06         RLAM.W  #0x2, R14
   \   000014   0D48         MOV.W   R8, R13
   \   000016   0D5E         ADD.W   R14, R13
   \   000018   1E4D0400     MOV.W   0x4(R13), R14
   \   00001C   1D4B0800     MOV.W   0x8(R11), R13
   \   000020   7C400900     MOV.B   #0x9, R12
   \   000024   ........     CALLA   #zclFindAttrRec
   1103              {
   1104                // Notify the device of success (or otherwise) of the its original configure
   1105                // reporting command, for each attribute.
   1106              }
   1107            }
   \   000028   5A53         ADD.B   #0x1, R10
   \                     ??simplemeter_ProcessInConfigReportRspCmd_1:
   \   00002A   6A98         CMP.B   @R8, R10
   \   00002C   F02B         JNC     ??simplemeter_ProcessInConfigReportRspCmd_0
   1108          
   1109            return TRUE;
   \   00002E   5C43         MOV.B   #0x1, R12
   \   000030   3152         ADD.W   #0x8, SP
   \   000032   3817         POPM.W  #0x4, R11
   \   000034   1001         RETA
   1110          }
   1111          
   1112          /*********************************************************************
   1113           * @fn      simplemeter_ProcessInReadReportCfgCmd
   1114           *
   1115           * @brief   Process the "Profile" Read Reporting Configuration Command
   1116           *
   1117           * @param   pInMsg - incoming message to process
   1118           *
   1119           * @return  none
   1120           */

   \                                 In  segment CODE, align 2, keep-with-next
   1121          static uint8 simplemeter_ProcessInReadReportCfgCmd( zclIncomingMsg_t *pInMsg )
   \                     simplemeter_ProcessInReadReportCfgCmd:
   1122          {
   \   000000   5B15         PUSHM.W #0x6, R11
   \   000002   3182         SUB.W   #0x8, SP
   \   000004   084C         MOV.W   R12, R8
   1123            zclReadReportCfgCmd_t *readReportCfgCmd;
   1124            zclReadReportCfgRspCmd_t *readReportCfgRspCmd;
   1125            zclReportCfgRspRec_t *reportRspRec;
   1126            zclAttrRec_t attrRec;
   1127            uint8 reportChangeLen;
   1128            uint8 *dataPtr;
   1129            uint8 hdrLen;
   1130            uint8 dataLen = 0;
   \   000006   4B43         MOV.B   #0x0, R11
   1131            uint8 status;
   1132            uint8 i;
   1133          
   1134            readReportCfgCmd = (zclReadReportCfgCmd_t *)pInMsg->attrCmd;
   \   000008   194C1800     MOV.W   0x18(R12), R9
   1135          
   1136            // Find out the response length (Reportable Change field is of variable length)
   1137            for ( i = 0; i < readReportCfgCmd->numAttr; i++ )
   \   00000C   4A43         MOV.B   #0x0, R10
   \   00000E   193C         JMP     ??simplemeter_ProcessInReadReportCfgCmd_2
   1138            {
   1139              // For supported attributes with 'analog' data type, find out the length of
   1140              // the Reportable Change field
   1141              if ( zclFindAttrRec( SIMPLEMETER_ENDPOINT, pInMsg->clusterId,
   1142                                   readReportCfgCmd->attrList[i].attrID, &attrRec ) )
   \                     ??simplemeter_ProcessInReadReportCfgCmd_0:
   \   000010   0F41         MOV.W   SP, R15
   \   000012   474A         MOV.B   R10, R7
   \   000014   5706         RLAM.W  #0x2, R7
   \   000016   0E49         MOV.W   R9, R14
   \   000018   0E57         ADD.W   R7, R14
   \   00001A   1E4E0400     MOV.W   0x4(R14), R14
   \   00001E   ........     CALLA   #?Subroutine1
   \                     ??CrossCallReturnLabel_2:
   \   000022   0E24         JEQ     ??simplemeter_ProcessInReadReportCfgCmd_3
   1143              {
   1144                if ( zclAnalogDataType( attrRec.attr.dataType ) )
   \   000024   5C410400     MOV.B   0x4(SP), R12
   \   000028   ........     CALLA   #zclAnalogDataType
   \   00002C   4C93         CMP.B   #0x0, R12
   \   00002E   0824         JEQ     ??simplemeter_ProcessInReadReportCfgCmd_3
   1145                {
   1146                   reportChangeLen = zclGetDataTypeLength( attrRec.attr.dataType );
   \   000030   5C410400     MOV.B   0x4(SP), R12
   \   000034   ........     CALLA   #zclGetDataTypeLength
   1147          
   1148                   // add padding if neede
   1149                   if ( PADDING_NEEDED( reportChangeLen ) )
   \   000038   5CB3         BIT.B   #0x1, R12
   \   00003A   0128         JNC     ??simplemeter_ProcessInReadReportCfgCmd_4
   1150                     reportChangeLen++;
   \   00003C   5C53         ADD.B   #0x1, R12
   1151                   dataLen += reportChangeLen;
   \                     ??simplemeter_ProcessInReadReportCfgCmd_4:
   \   00003E   4B5C         ADD.B   R12, R11
   1152                }
   1153              }
   1154            }
   \                     ??simplemeter_ProcessInReadReportCfgCmd_3:
   \   000040   5A53         ADD.B   #0x1, R10
   \                     ??simplemeter_ProcessInReadReportCfgCmd_2:
   \   000042   6E49         MOV.B   @R9, R14
   \   000044   4A9E         CMP.B   R14, R10
   \   000046   E42B         JNC     ??simplemeter_ProcessInReadReportCfgCmd_0
   1155          
   1156            hdrLen = sizeof( zclReadReportCfgRspCmd_t ) + ( readReportCfgCmd->numAttr * sizeof( zclReportCfgRspRec_t ) );
   1157          
   1158            // Allocate space for the response command
   1159            readReportCfgRspCmd = (zclReadReportCfgRspCmd_t *)osal_mem_alloc( hdrLen + dataLen );
   \   000048   6C43         MOV.B   #0x2, R12
   \   00004A                RPT     #0xe
   \   00004A   4D184C5E     ADDX.B  R14, R12
   \   00004E   4C4C         MOV.B   R12, R12
   \   000050   0C5B         ADD.W   R11, R12
   \   000052   ........     CALLA   #osal_mem_alloc
   \   000056   0B4C         MOV.W   R12, R11
   1160            if ( readReportCfgRspCmd == NULL )
   \   000058   0C93         CMP.W   #0x0, R12
   \   00005A   0220         JNE     ??simplemeter_ProcessInReadReportCfgCmd_5
   1161              return FALSE; // EMBEDDED RETURN
   \   00005C   4C43         MOV.B   #0x0, R12
   \   00005E   353C         JMP     ??simplemeter_ProcessInReadReportCfgCmd_6
   1162          
   1163            dataPtr = (uint8 *)( (uint8 *)readReportCfgRspCmd + hdrLen );
   1164            readReportCfgRspCmd->numAttr = readReportCfgCmd->numAttr;
   \                     ??simplemeter_ProcessInReadReportCfgCmd_5:
   \   000060   EC490000     MOV.B   @R9, 0(R12)
   1165            for (i = 0; i < readReportCfgCmd->numAttr; i++)
   \   000064   4A43         MOV.B   #0x0, R10
   \   000066   1A3C         JMP     ??simplemeter_ProcessInReadReportCfgCmd_7
   1166            {
   1167              reportRspRec = &(readReportCfgRspCmd->attrList[i]);
   \                     ??simplemeter_ProcessInReadReportCfgCmd_1:
   \   000068   4F4A         MOV.B   R10, R15
   \   00006A   074F         MOV.W   R15, R7
   \   00006C                RPT     #0xd
   \   00006C   4C18075F     ADDX.W  R15, R7
   \   000070   064B         MOV.W   R11, R6
   \   000072   0657         ADD.W   R7, R6
   \   000074   2653         ADD.W   #0x2, R6
   1168          
   1169              if ( zclFindAttrRec( SIMPLEMETER_ENDPOINT, pInMsg->clusterId,
   1170                                   readReportCfgCmd->attrList[i].attrID, &attrRec ) )
   \   000076   5F06         RLAM.W  #0x2, R15
   \   000078   0749         MOV.W   R9, R7
   \   00007A   075F         ADD.W   R15, R7
   \   00007C   2752         ADD.W   #0x4, R7
   \   00007E   0F41         MOV.W   SP, R15
   \   000080   2E47         MOV.W   @R7, R14
   \   000082   ........     CALLA   #??Subroutine3_0
   \                     ??CrossCallReturnLabel_4:
   \   000086   0320         JNE     ??simplemeter_ProcessInReadReportCfgCmd_8
   \   000088   7E408600     MOV.B   #0x86, R14
   \   00008C   023C         JMP     ??simplemeter_ProcessInReadReportCfgCmd_9
   \                     ??simplemeter_ProcessInReadReportCfgCmd_8:
   \   00008E   7E408C00     MOV.B   #0x8c, R14
   1171              {
   1172                if ( zcl_MandatoryReportableAttribute( &attrRec ) == TRUE )
   1173                {
   1174                  // Get the Reporting Configuration
   1175                  // status = zclReadReportCfg( readReportCfgCmd->attrID[i], reportRspRec );
   1176                  status = ZCL_STATUS_UNREPORTABLE_ATTRIBUTE; // for now
   1177                  if ( status == ZCL_STATUS_SUCCESS && zclAnalogDataType( attrRec.attr.dataType ) )
   1178                  {
   1179                    reportChangeLen = zclGetDataTypeLength( attrRec.attr.dataType );
   1180                    //osal_memcpy( dataPtr, pBuf, reportChangeLen );
   1181                    reportRspRec->reportableChange = dataPtr;
   1182          
   1183                    // add padding if needed
   1184                    if ( PADDING_NEEDED( reportChangeLen ) )
   1185                      reportChangeLen++;
   1186                    dataPtr += reportChangeLen;
   1187                  }
   1188                }
   1189                else
   1190                {
   1191                  // Attribute not in the Mandatory Reportable Attribute list
   1192                  status = ZCL_STATUS_UNREPORTABLE_ATTRIBUTE;
   1193                }
   1194              }
   1195              else
   1196              {
   1197                // Attribute not found
   1198                status = ZCL_STATUS_UNSUPPORTED_ATTRIBUTE;
   1199              }
   1200          
   1201              reportRspRec->status = status;
   \                     ??simplemeter_ProcessInReadReportCfgCmd_9:
   \   000092   C64E0000     MOV.B   R14, 0(R6)
   1202              reportRspRec->attrID = readReportCfgCmd->attrList[i].attrID;
   \   000096   A6470200     MOV.W   @R7, 0x2(R6)
   1203            }
   \   00009A   5A53         ADD.B   #0x1, R10
   \                     ??simplemeter_ProcessInReadReportCfgCmd_7:
   \   00009C   1D480800     MOV.W   0x8(R8), R13
   \   0000A0   6A99         CMP.B   @R9, R10
   \   0000A2   E22B         JNC     ??simplemeter_ProcessInReadReportCfgCmd_1
   1204          
   1205            // Send the response back
   1206            zcl_SendReadReportCfgRspCmd( SIMPLEMETER_ENDPOINT, &(pInMsg->srcAddr),
   1207                                         pInMsg->clusterId, readReportCfgRspCmd, ZCL_FRAME_SERVER_CLIENT_DIR,
   1208                                         TRUE, pInMsg->zclHdr.transSeqNum );
   \   0000A4   58120600     PUSH.B  0x6(R8)
   \   0000A8   5312         PUSH.B  #0x1
   \   0000AA   5312         PUSH.B  #0x1
   \   0000AC   0F4B         MOV.W   R11, R15
   \   0000AE   0E4D         MOV.W   R13, R14
   \   0000B0   38500A00     ADD.W   #0xa, R8
   \   0000B4   0D48         MOV.W   R8, R13
   \   0000B6   7C400900     MOV.B   #0x9, R12
   \   0000BA   ........     CALLA   #zcl_SendReadReportCfgRspCmd
   1209            osal_mem_free( readReportCfgRspCmd );
   \   0000BE   0C4B         MOV.W   R11, R12
   \   0000C0   ........     CALLA   #osal_mem_free
   1210          
   1211            return TRUE;
   \   0000C4   5C43         MOV.B   #0x1, R12
   \   0000C6   31500600     ADD.W   #0x6, SP
   \                     ??simplemeter_ProcessInReadReportCfgCmd_6:
   \   0000CA                REQUIRE ?Subroutine0
   \   0000CA                // Fall through to label ?Subroutine0
   1212          }

   \                                 In  segment DATA16_ID, align 1, align-sorted
   \                     `?<Initializer for numAttr>`:
   \   000000   01           DC8 1

   \                                 In  segment DATA16_ID, align 2, align-sorted
   \                     `?<Initializer for simplemeter_GenCmdCallbacks>`:
   \   000000   ............ DC32 simplemeter_BasicResetCB, simplemeter_IdentifyCB
   \            ....        
   \   000008   ........0000 DC32 simplemeter_IdentifyQueryRspCB, 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H
   \            000000000000
   \            000000000000
   \            000000000000
   \            000000000000
   \            000000000000
   \            00000000    
   \   000030   ........0000 DC32 simplemeter_AlarmCB, 0H, 0H
   \            000000000000

   \                                 In  segment DATA16_ID, align 2, align-sorted
   \                     `?<Initializer for simplemeter_SECmdCallbacks>`:
   \   000000   ............ DC32 simplemeter_GetProfileCmdCB, simplemeter_GetProfileRspCB
   \            ....        
   \   000008   ............ DC32 simplemeter_ReqMirrorCmdCB, simplemeter_ReqMirrorRspCB
   \            ....        
   \   000010   ............ DC32 simplemeter_MirrorRemCmdCB, simplemeter_MirrorRemRspCB, 0H, 0H, 0H
   \            ....00000000
   \            000000000000
   \            0000        
   \   000024   000000000000 DC32 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H
   \            000000000000
   \            000000000000
   \            000000000000
   \            000000000000
   \            000000000000
   \            000000000000
   \            000000000000
   \            000000000000
   \            000000000000
   \            000000000000
   \            0000        

   \                                 In  segment DATA16_C, align 2, align-sorted
   \                     `?<Constant {10485761L, 10485762L, 10485763L, 1`:
   \   000000   0100A0000200 DC32 10485761, 10485762, 10485763, 10485764, 10485765
   \            A0000300A000
   \            0400A0000500
   \            A000        
   1213          
   1214          /*********************************************************************
   1215           * @fn      simplemeter_ProcessInReadReportCfgRspCmd
   1216           *
   1217           * @brief   Process the "Profile" Read Reporting Configuration Response Command
   1218           *
   1219           * @param   pInMsg - incoming message to process
   1220           *
   1221           * @return  none
   1222           */
   1223          static uint8 simplemeter_ProcessInReadReportCfgRspCmd( zclIncomingMsg_t *pInMsg )
   1224          {
   1225            zclReadReportCfgRspCmd_t *readReportCfgRspCmd;
   1226            zclReportCfgRspRec_t *reportRspRec;
   1227            uint8 i;
   1228          
   1229            readReportCfgRspCmd = (zclReadReportCfgRspCmd_t *)pInMsg->attrCmd;
   1230            for ( i = 0; i < readReportCfgRspCmd->numAttr; i++ )
   1231            {
   1232              reportRspRec = &(readReportCfgRspCmd->attrList[i]);
   1233          
   1234              // Notify the device of the results of the its original read reporting
   1235              // configuration command.
   1236          
   1237              if ( reportRspRec->status == ZCL_STATUS_SUCCESS )
   1238              {
   1239                if ( reportRspRec->direction == ZCL_SEND_ATTR_REPORTS )
   1240                {
   1241                  // add user code here
   1242                }
   1243                else
   1244                {
   1245                  // expecting attribute reports
   1246                }
   1247              }
   1248            }
   1249          
   1250            return TRUE;
   1251          }
   1252          
   1253          /*********************************************************************
   1254           * @fn      simplemeter_ProcessInReportCmd
   1255           *
   1256           * @brief   Process the "Profile" Report Command
   1257           *
   1258           * @param   pInMsg - incoming message to process
   1259           *
   1260           * @return  none
   1261           */
   1262          static uint8 simplemeter_ProcessInReportCmd( zclIncomingMsg_t *pInMsg )
   1263          {
   1264            zclReportCmd_t *reportCmd;
   1265            uint8 i;
   1266          
   1267            reportCmd = (zclReportCmd_t *)pInMsg->attrCmd;
   1268            for (i = 0; i < reportCmd->numAttr; i++)
   1269            {
   1270              // add user code here
   1271            }
   1272          
   1273            return TRUE;
   1274          }
   1275          #endif // ZCL_REPORT
   1276          
   1277          /*********************************************************************
   1278           * @fn      simplemeter_ProcessInDefaultRspCmd
   1279           *
   1280           * @brief   Process the "Profile" Default Response Command
   1281           *
   1282           * @param   pInMsg - incoming message to process
   1283           *
   1284           * @return  none
   1285           */
   1286          static uint8 simplemeter_ProcessInDefaultRspCmd( zclIncomingMsg_t *pInMsg )
   1287          {
   1288            // zclDefaultRspCmd_t *defaultRspCmd = (zclDefaultRspCmd_t *)pInMsg->attrCmd;
   1289          
   1290            // Device is notified of the Default Response command.
   1291          
   1292            return TRUE;
   1293          }
   1294          
   1295          #if defined ( ZCL_DISCOVER )
   1296          /*********************************************************************
   1297           * @fn      simplemeter_ProcessInDiscRspCmd
   1298           *
   1299           * @brief   Process the "Profile" Discover Response Command
   1300           *
   1301           * @param   pInMsg - incoming message to process
   1302           *
   1303           * @return  none
   1304           */
   1305          static uint8 simplemeter_ProcessInDiscRspCmd( zclIncomingMsg_t *pInMsg )
   1306          {
   1307            zclDiscoverRspCmd_t *discoverRspCmd;
   1308            uint8 i;
   1309          
   1310            discoverRspCmd = (zclDiscoverRspCmd_t *)pInMsg->attrCmd;
   1311            for ( i = 0; i < discoverRspCmd->numAttr; i++ )
   1312            {
   1313              // Device is notified of the result of its attribute discovery command.
   1314            }
   1315          
   1316            return TRUE;
   1317          }
   1318          #endif // ZCL_DISCOVER
   1319          
   1320          /****************************************************************************
   1321          ****************************************************************************/

   Maximum stack usage in bytes:

   CSTACK Function
   ------ --------
       4  simplemeter_AlarmCB
       4  simplemeter_BasicResetCB
      40  simplemeter_GetProfileCmdCB
            40 -> zclSE_SimpleMetering_Send_GetProfileRsp
       4  simplemeter_GetProfileRspCB
       4  simplemeter_IdentifyCB
             4 -> simplemeter_ProcessIdentifyTimeChange
       4  simplemeter_IdentifyQueryRspCB
       8  simplemeter_Init
             8 -> RegisterForKeys
             8 -> ZDO_RegisterForZDOMsg
             8 -> osal_mem_alloc
             8 -> osal_start_timerEx
             8 -> zclGeneral_RegisterCmdCallbacks
             8 -> zclSE_Init
             8 -> zclSE_RegisterCmdCallbacks
             8 -> zcl_registerAttrList
             8 -> zcl_registerClusterOptionList
             8 -> zcl_registerForMsg
             8 -> zcl_registerValidateAttrData
       4  simplemeter_MirrorRemCmdCB
       4  simplemeter_MirrorRemRspCB
       4  simplemeter_ProcessIdentifyTimeChange
             4 -> HalLedBlink
             4 -> HalLedSet
             4 -> osal_start_timerEx
             4 -> osal_stop_timerEx
      30  simplemeter_ProcessInConfigReportCmd
            24 -> osal_mem_alloc
            30 -> osal_mem_free
            24 -> zclFindAttrRec
            30 -> zcl_SendConfigReportRspCmd
      20  simplemeter_ProcessInConfigReportRspCmd
            20 -> zclFindAttrRec
      30  simplemeter_ProcessInReadReportCfgCmd
            24 -> osal_mem_alloc
            30 -> osal_mem_free
            24 -> zclAnalogDataType
            24 -> zclFindAttrRec
            24 -> zclGetDataTypeLength
            30 -> zcl_SendReadReportCfgRspCmd
       8  simplemeter_ProcessZCLMsg
             8 -> osal_mem_free
             8 -> simplemeter_ProcessInConfigReportCmd
             8 -> simplemeter_ProcessInConfigReportRspCmd
             8 -> simplemeter_ProcessInReadReportCfgCmd
       8  simplemeter_ProcessZDOMsgs
             8 -> ZDO_ParseEPListRsp
             8 -> osal_mem_free
             8 -> osal_set_event
       4  simplemeter_ReqMirrorCmdCB
       4  simplemeter_ReqMirrorRspCB
       4  simplemeter_ValidateAttrDataCB
      18  simplemeter_event_loop
            12 -> NLME_SetPollRate
            12 -> ZDOInitDevice
            12 -> osal_getClock
            12 -> osal_msg_deallocate
            12 -> osal_msg_receive
            12 -> osal_start_timerEx
            18 -> osal_start_timerEx
            12 -> simplemeter_ProcessIdentifyTimeChange
            12 -> simplemeter_ProcessZCLMsg
            12 -> simplemeter_ProcessZDOMsgs
            12 -> zclGeneral_KeyEstablish_InitiateKeyEstablishment
            18 -> zcl_SendReportCmd


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
      20  ?<Constant {10485761L, 10485762L, 10485763L, 1
       1  ?<Initializer for numAttr>
      60  ?<Initializer for simplemeter_GenCmdCallbacks>
     104  ?<Initializer for simplemeter_SECmdCallbacks>
      12  ??Subroutine3_0
       6  ?Subroutine0
       4  ?Subroutine1
      12  ?Subroutine2
      12  ESPAddr
       1  numAttr
       2  pReportCmd
       1  simpleMeterTaskID
       1  simpleMeterTransID
       2  simplemeter_AlarmCB
       2  simplemeter_BasicResetCB
      60  simplemeter_GenCmdCallbacks
      70  simplemeter_GetProfileCmdCB
       2  simplemeter_GetProfileRspCB
      10  simplemeter_IdentifyCB
       2  simplemeter_IdentifyQueryRspCB
     182  simplemeter_Init
       2  simplemeter_MirrorRemCmdCB
       2  simplemeter_MirrorRemRspCB
      54  simplemeter_ProcessIdentifyTimeChange
     178  simplemeter_ProcessInConfigReportCmd
      54  simplemeter_ProcessInConfigReportRspCmd
     202  simplemeter_ProcessInReadReportCfgCmd
     132  simplemeter_ProcessZCLMsg
      60  simplemeter_ProcessZDOMsgs
       2  simplemeter_ReqMirrorCmdCB
       2  simplemeter_ReqMirrorRspCB
     104  simplemeter_SECmdCallbacks
      28  simplemeter_ValidateAttrDataCB
     274  simplemeter_event_loop

 
 1 294 bytes in segment CODE
    20 bytes in segment DATA16_C
   165 bytes in segment DATA16_I
   165 bytes in segment DATA16_ID
    16 bytes in segment DATA16_Z
 
 1 294 bytes of CODE  memory
   185 bytes of CONST memory
   181 bytes of DATA  memory

Errors: none
Warnings: none
